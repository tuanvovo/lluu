<script>
const allPins = ["V1", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10"];
const v10Mapping = {"1":"V3", "2":"V4", "3":"V6", "4":"V5", "5":"V7", "6":"V8"};
const idLookup = {"V1":1,"V2":2,"V3":3,"V4":4,"V5":5,"V6":6,"V7":7,"V8":8,"V9":9,"V10":10};
let customNames = {};
let listV2 = [], listV10 = [];

// --- CẤU HÌNH THÔNG MINH ---
const IP_ESP32 = "192.168.1.200"; 
const segment = "1"; // Định nghĩa số segment để tránh lỗi fetch
const WORKER_URL = "https://blynk-token-proxy.tanthanhlttb123.workers.dev";
const DEVICE_NAME = "cay";

const isLocal = window.location.hostname.includes("192.168") || window.location.hostname === "localhost";
const basePrefix = isLocal ? `http://${IP_ESP32}` : WORKER_URL;

//---------------------------------------------------------------------
document.addEventListener("DOMContentLoaded", function() {
    let cachedNames = localStorage.getItem('last_config');
    let cachedV2 = localStorage.getItem('v2_list_cache');
    let cachedV10 = localStorage.getItem('v10_list_cache');

    if(cachedNames) customNames = JSON.parse(cachedNames);
    if(cachedV2) listV2 = JSON.parse(cachedV2);
    if(cachedV10) listV10 = JSON.parse(cachedV10);

    renderUI(); 

    if (isLocal) {
        fetch('/get_config?t=' + Date.now()).then(r => r.json()).then(data => {
            if(data && Object.keys(data).length > 0) {
                customNames = data;
                localStorage.setItem('last_config', JSON.stringify(data));
                renderUI();
            }
        }).catch(()=>{});
    }
    setInterval(updateStatusOnly, 3000);
});

// Hàm lấy thông báo giọng nói
setInterval(function() {
    if (!isLocal) return;
    fetch('/get_notify').then(r => r.text()).then(txt => {
        if (txt && txt.trim().length > 1) {
            let msg = new SpeechSynthesisUtterance(txt);
            msg.lang = 'vi-VN';
            window.speechSynthesis.speak(msg);
        }
    }).catch(e => {});
}, 1000);

function renderUI() {
    let h = "";
    allPins.forEach(p => {
        let savedImg = localStorage.getItem('img_' + p);
        let imgSrc = "";
        
        if (savedImg) {
            imgSrc = savedImg; // Ưu tiên ảnh nét trong máy
        } else if (isLocal) {
            imgSrc = `/${p.toUpperCase()}.JPG?t=${Date.now()}`; // Lấy từ ESP32 nếu ở nhà
        } else {
            imgSrc = "https://via.placeholder.com/150/cccccc/ffffff?text=" + p;
        }

        h += `<div class="device-card">
            <img src="${imgSrc}" id="img-tag-${p}"
            class="device-img" 
            onerror="this.src='https://via.placeholder.com/150/cccccc/ffffff?text=No+Image'"
            onclick="uploadImg('${p}')" >
            <span id="name-device-${p}" style="cursor:pointer; font-weight:bold; margin-top:5px; display:block;" onclick="editName('${p}')">
                ${customNames[p] || p} ✏️
            </span>
            <div class="btn-group">
                <button id="on-${p}" class="btn btn-on" onclick="sendCmd('${p}',1)">BẬT</button>
                <button id="off-${p}" class="btn btn-off" onclick="sendCmd('${p}',0)">TẮT</button>
            </div>
        </div>`;
    });
    document.getElementById('device_list').innerHTML = h;

    // Load options cho V10
    let opt = "";
    for (let id in v10Mapping) {
        opt += `<option value="${id}">${customNames[v10Mapping[id]] || ("Đèn " + id)}</option>`;
    }
    let v10Select = document.getElementById('v10_id');
    if(v10Select) v10Select.innerHTML = opt;

    document.getElementById('v2_list').innerHTML = listV2.map((x, i) => 
        `<div class="list-item"><span><b>${x.t}</b> - Tưới ${x.d}p</span><span class="btn-del" onclick="removeV2(${i})">✖</span></div>`
    ).join('') || '<div style="color:#ccc;text-align:center">Trống</div>';

    document.getElementById('v10_list').innerHTML = listV10.map((x, i) => 
        `<div class="list-item"><span><b>${customNames[v10Mapping[x.id]] || 'Đèn '+x.id}:</b> ${x.on} ➔ ${x.off}</span><span class="btn-del" onclick="removeV10(${i})">✖</span></div>`
    ).join('') || '<div style="color:#ccc;text-align:center">Trống</div>';
}

// --- HÀM CHỌN ẢNH SIÊU NÉT ---
function uploadImg(pin) {
    let input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = e => {
        let file = e.target.files[0];
        if (!file) return;

        let reader = new FileReader();
        reader.onload = event => {
            let img = new Image();
            img.onload = () => {
                let canvas = document.createElement('canvas');
                let ctx = canvas.getContext('2d');

                // 1. LƯU BẢN NÉT VÀO LOCALSTORAGE (Dùng cho Web Git)
                let MAX_WEB = 600; 
                let scaleWeb = MAX_WEB / img.width;
                canvas.width = MAX_WEB;
                canvas.height = img.height * scaleWeb;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                let highResData = canvas.toDataURL('image/jpeg', 0.8);
                try {
                    localStorage.setItem('img_' + pin, highResData);
                    document.getElementById('img-tag-' + pin).src = highResData;
                } catch(e) { console.log("Bộ nhớ đầy, không thể lưu ảnh nét"); }

                // 2. NÉN 20KB GỬI ESP32 (Chỉ gửi khi ở nhà - isLocal)
                if (isLocal) {
                    let MAX_ESP = 300;
                    let scaleESP = MAX_ESP / img.width;
                    canvas.width = MAX_ESP;
                    canvas.height = img.height * scaleESP;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob(blob => {
                        let formData = new FormData();
                        formData.append("image", blob, pin.toUpperCase() + ".JPG");
                        fetch('/upload', { method: 'POST', body: formData });
                    }, 'image/jpeg', 0.5);
                }
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };
    input.click();
}

// Các hàm bổ trợ giữ nguyên
function sendCmd(p, v) {
    let status = (v == 1) ? "ON" : "OFF";
    let finalUrl = isLocal 
        ? `${basePrefix}/cmd?id=${idLookup[p]}&val=${status}`
        : `${basePrefix}?action=update&pin=${p}&value=${v}&device=${DEVICE_NAME}`;
    fetch(finalUrl, { mode: 'no-cors' });
    if ('speechSynthesis' in window) {
        window.speechSynthesis.speak(new SpeechSynthesisUtterance((v == 1 ? "Bật " : "Tắt ") + (customNames[p] || p)));
    }
}

function updateStatusOnly() {
    let statusUrl = isLocal ? `${basePrefix}/get_status` : `${basePrefix}?action=get_all&device=${DEVICE_NAME}`;
    fetch(statusUrl).then(r => r.json()).then(data => {
        for (let p in data) {
            let onBtn = document.getElementById(`on-${p}`);
            let offBtn = document.getElementById(`off-${p}`);
            if(onBtn && offBtn) {
                if (data[p] == 1) {
                    onBtn.className = "btn btn-on active-on";
                    offBtn.className = "btn btn-off";
                } else {
                    onBtn.className = "btn btn-on";
                    offBtn.className = "btn btn-off active-off";
                }
            }
        }
    }).catch(e => {});
}

function addV2() {
    let t = document.getElementById('v2_t').value;
    let d = document.getElementById('v2_d').value;
    if(t && d) {
        if (listV2.length >= 6) return alert("Tối đa 6 lần!");
        listV2.push({t, d}); renderUI(); 
    }
}

function saveV2(btn) {
    let full = [];
    for(let i=0; i<6; i++) {
        if(listV2[i]) {
            let p = listV2[i].t.split(':');
            full.push({id:i+1, h:parseInt(p[0]), m:parseInt(p[1]), d:parseInt(listV2[i].d), a:true});
        } else {
            full.push({id:i+1, h:0, m:0, d:0, a:false});
        }
    }
    localStorage.setItem('v2_list_cache', JSON.stringify(listV2));
    fetch('/irrigation?d=' + encodeURIComponent(JSON.stringify(full))).then(() => {
        btn.innerText = "✅ ĐÃ LƯU!"; setTimeout(() => btn.innerText = "GỬI & LƯU LỊCH TƯỚI", 2000);
    });
}

function addV10() {
    let id = document.getElementById('v10_id').value;
    let on = document.getElementById('v10_on').value;
    let off = document.getElementById('v10_off').value;
    if(on && off) {
        listV10 = listV10.filter(x => x.id !== id);
        listV10.push({id, on, off}); renderUI();
    }
}

function saveV10(btn) {
    localStorage.setItem('v10_list_cache', JSON.stringify(listV10));
    let dataStr = listV10.map(s => `id:${s.id} ${s.on} true ${s.off} false`).join(', ');
    fetch('/schedule_save?d=' + encodeURIComponent(dataStr));
    btn.innerText = "✅ ĐÃ LƯU!"; setTimeout(() => btn.innerText = "GỬI & LƯU LỊCH ĐÈN", 2000);
}

function removeV2(i) {
    if(confirm("Xóa lịch?")) { listV2.splice(i, 1); renderUI(); saveV2({innerText:""}); }
}

function removeV10(i) {
    if(confirm("Xóa lịch?")) { listV10.splice(i, 1); renderUI(); saveV10({innerText:""}); }
}

function editName(p) {
    let oldName = (customNames[p] || p);
    let newName = prompt("Tên mới:", oldName);
    if (newName && newName !== oldName) {
        fetch(`/set_name?pin=${p}&name=${encodeURIComponent(newName)}`).then(() => {
            customNames[p] = newName;
            localStorage.setItem('last_config', JSON.stringify(customNames));
            renderUI();
        });
    }
}

function phatWifiConfig() {
    let code = prompt("MÃ XÁC THỰC:");
    if (!code) return;
    fetch('/phat_wifi_ap?auth_code=' + encodeURIComponent(code))
    .then(r => r.text()).then(txt => alert(txt)).catch(() => alert("Đang chuyển chế độ..."));
}
</script>
