<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ESP8266 MQTT Control (SSL 443)</title>
<script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
<style>
    body { font-family: Arial; text-align:center; margin-top:50px; }
    h2 { color:#333; }
    button {
        font-size: 20px; padding: 15px 40px; margin: 20px; border: none;
        border-radius: 10px; cursor: pointer; transition: all 0.1s ease;
        box-shadow: 0 5px #999; color: white;
    }
    #onBtn { background-color: #4CAF50; }
    #offBtn { background-color: #f44336; }
    button:active { transform: translateY(4px); box-shadow: 0 1px #666; }
</style>
</head>
<body>
<h2>ESP8266 MQTT chuan Control - Giao thức Chuẩn 443</h2>
<button id="onBtn">ON</button>
<button id="offBtn">OFF</button>

<p id="status">Đang thiết lập kết nối WSS...</p>

<script>
    // ----------------------------------------------------------------
    // CẤU HÌNH WSS CHUẨN (CỔNG 443 LUÔN MỞ)
    // ----------------------------------------------------------------
    const broker = "broker.hivemq.com"; // Đồng bộ với ESP
    const port = 443; // Cổng WSS chuẩn HTTPS, không bị tường lửa chặn
    const clientId = "web_" + Math.floor(Math.random() * 1000000);
    const topic = "esp8266/control"; // Đồng bộ với ESP8266

    const client = new Paho.MQTT.Client(broker, port, clientId);
    
    let onBtn = document.getElementById("onBtn");
    let offBtn = document.getElementById("offBtn");
    let statusP = document.getElementById("status");

    function onConnect() {
        console.log("✅ WSS CONNECTED (Port 443)");
        statusP.innerText = "✅ Đã kết nối WSS. Sẵn sàng gửi lệnh!";
    }

    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("❌ CONNECTION LOST:", responseObject.errorMessage);
        }
        statusP.innerText = "❌ Mất kết nối! Đang thử kết nối lại...";
        client.connect({ useSSL: true, onSuccess: onConnect, onFailure: onFailure });
    }

    function onFailure(e) {
        console.log("❌ CONNECT FAILED:", e);
        statusP.innerText = `❌ Lỗi kết nối WSS: ${e.errorMessage}. Thử hard refresh (Ctrl+F5).`;
    }

    function sendCommand(cmd) {
        if (!client.isConnected()) {
            console.error("❌ Not connected.");
            statusP.innerText = "❌ Chưa kết nối! Vui lòng chờ.";
            return;
        }
        
        const message = new Paho.MQTT.Message(cmd);
        message.destinationName = topic;
        client.send(message);
        console.log(`SENT: ${cmd}`);

        if(cmd === "ON") {
            onBtn.style.backgroundColor = "#2e7d32";
            offBtn.style.backgroundColor = "#f44336";
        } else if (cmd === "OFF") {
            offBtn.style.backgroundColor = "#b71c1c";
            onBtn.style.backgroundColor = "#4CAF50";
        }
    }
    
    client.onConnectionLost = onConnectionLost;

    // BẮT ĐẦU KẾT NỐI VỚI THAM SỐ useSSL: true VÀ PORT 443
    client.connect({
        useSSL: true, // BẮT BUỘC
        onSuccess: onConnect,
        onFailure: onFailure
    });

    onBtn.addEventListener('click', () => sendCommand("ON"));
    offBtn.addEventListener('click', () => sendCommand("OFF"));
</script>
</body>
</html>