<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ESP8266 MQTT ON/OFF Feedback</title>
<script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
<style>
 body { font-family: Arial; text-align:center; margin-top:50px; }
 h2 { color:#333; }
 button {
 font-size: 20px;
 padding: 15px 40px;
 margin: 20px;
 border: none;
 border-radius: 10px;
 cursor: pointer;
 transition: all 0.1s ease;
 box-shadow: 0 5px #999;
 color: white;
 }
 #onBtn { background-color: #4CAF50; }
 #offBtn { background-color: #f44336; }
 button:active {
 transform: translateY(4px);
 box-shadow: 0 1px #666;
 }
</style>
</head>
<body>
<h2>ESP8266 MQTT3 ON/OFF Feedback</h2>
<button id="onBtn">ON</button>
<button id="offBtn">OFF</button>

<p id="status">Dang ket noi...</p>

<script>
    // ----------------------------------------------------------------
    // C
    // ----------------------------------------------------------------
    const broker = "broker.hivemq.com";
    const port = 8884; // 
    const clientId = "web_" + Math.floor(Math.random() * 1000000);
    const topic = "esp8266/control";

    const client = new Paho.MQTT.Client(broker, port, clientId);
    
    let onBtn = document.getElementById("onBtn");
    let offBtn = document.getElementById("offBtn");
    let statusP = document.getElementById("status");

    // ----------------------------------------------------------------
    // H
    // ----------------------------------------------------------------
    
    function onConnect() {
        console.log("✅ Connected to HiveMQ WSS");
        statusP.innerText = "✅ da ket noi san sang nhan lenh";
        // 
        // client.subscribe(topic); 
    }

    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("Connection Lost:", responseObject.errorMessage);
            statusP.innerText = "❌ mat ket noi dang thu lai ket noi...";
        }
        // T
        client.connect({ useSSL: true, onSuccess: onConnect, onFailure: onFailure });
    }

    function onFailure(e) {
        console.log("Connect failed:", e);
        statusP.innerText = `❌ loi ket noi: ${e.errorMessage}`;
    }

    function sendCommand(cmd) {
        if (!client.isConnected()) {
            console.error("Client not connected. Cannot send command.");
            statusP.innerText = "❌ chua ket noi! vui long cho.";
            return;
        }
        
        const message = new Paho.MQTT.Message(cmd);
        message.destinationName = topic;
        client.send(message);
        console.log(`Sent ${cmd} to topic ${topic}`);

        // Feedback
        if(cmd === "ON") {
            onBtn.style.backgroundColor = "#2e7d32";
            offBtn.style.backgroundColor = "#f44336";
        } else if (cmd === "OFF") {
            offBtn.style.backgroundColor = "#b71c1c";
            onBtn.style.backgroundColor = "#4CAF50";
        }
    }
    
    // ----------------------------------------------------------------
    // K
    // ----------------------------------------------------------------
    
    // 1. 
    client.onConnectionLost = onConnectionLost;

    // 2. 
    client.connect({
        useSSL: true, // 
        onSuccess: onConnect,
        onFailure: onFailure
    });

    // 3. 
    onBtn.addEventListener('click', () => sendCommand("ON"));
    offBtn.addEventListener('click', () => sendCommand("OFF"));

</script>
</body>
</html>
