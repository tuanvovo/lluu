<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>H·ªá Th·ªëng Th√¥ng Minh</title>
    <style>
        /* T√¨m v√† thay th·∫ø c√°c d√≤ng t∆∞∆°ng ·ª©ng trong :root v√† c√°c class btn */
:root { 
    --bg: #f0f2f5; 
    --primary: #1a73e8; 
    --on-active: #2ecc71;   /* Xanh ƒë·∫≠m khi B·∫¨T */
    --on-dim: #e8f5e9;      /* Xanh nh·∫°t khi ch∆∞a B·∫¨T */
    --off-active: #7f8c8d;  /* X√°m l√¥ng chu·ªôt ƒë·∫≠m khi T·∫ÆT */
    --off-dim: #f5f5f5;     /* X√°m l√¥ng chu·ªôt nh·∫°t khi ch∆∞a T·∫ÆT */
}
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .device-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; text-align: center; padding: 10px; display: flex; flex-direction: column; }
        .device-img { width: 100%; height: 100px; object-fit: cover; border-radius: 5px; cursor: pointer; background: #eee; transition: 0.3s; }
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .btn { border: none; padding: 8px; border-radius: 5px; cursor: pointer; flex: 1; font-weight: bold; font-size: 12px; }
        /* N√∫t B·∫¨T m·∫∑c ƒë·ªãnh */
.btn-on { background: var(--on-dim); color: var(--on-active); border: 1px solid var(--on-active); }
/* N√∫t T·∫ÆT m·∫∑c ƒë·ªãnh */
.btn-off { background: var(--off-dim); color: var(--off-active); border: 1px solid var(--off-active); }
      /* Khi ƒëang ·ªü tr·∫°ng th√°i B·∫¨T (Active) */
.active-on { background: var(--on-active) !important; color: white !important; }
/* Khi ƒëang ·ªü tr·∫°ng th√°i T·∫ÆT (Active) */
.active-off { background: var(--off-active) !important; color: white !important; }
       
       
        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
        .list-box { border: 1px solid #eee; padding: 10px; border-radius: 5px; margin-bottom: 10px; min-height: 40px; background: #fafafa; }
        .list-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; font-size: 13px; }
        .btn-del { color: red; cursor: pointer; font-weight: bold; padding: 0 10px; }
        .btn-save { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
   
         .device-img:active {
    transform: scale(0.95);
    opacity: 0.8;
}
   </style>
</head>
<body>

    <div class="card">
        <h3>ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã</h3>
        <div id="device_list" class="grid-container"></div>
    </div>

    <div class="card">
        <h3>L·ªãch T∆∞·ªõi Lan (V2)</h3>
        <div class="input-group">
            <input type="time" id="v2_t">
            <input type="number" id="v2_d" placeholder="Ph√∫t">
            <button onclick="addV2()" style="padding:0 15px;">+</button>
        </div>
        <div id="v2_list" class="list-box"></div>
        <button class="btn-save" style="background: var(--on)" onclick="saveV2(this)">G·ª¨I & L∆ØU L·ªäCH T∆Ø·ªöI</button>
    </div>

    <div class="card">
        <h3>L·∫≠p l·ªãch ƒê√®n (V10)</h3>
        <select id="v10_id"></select>
        <div class="input-group" style="margin-top:10px;">
            <input type="time" id="v10_on">
            <input type="time" id="v10_off">
            <button onclick="addV10()" style="padding:0 15px;">+</button>
        </div>
        <div id="v10_list" class="list-box"></div>
        <button class="btn-save" onclick="saveV10(this)">G·ª¨I & L∆ØU L·ªäCH ƒê√àN</button>
    </div>

    <button class="btn-save" style="background: #e67e22; margin-bottom: 30px;" onclick="phatWifiConfig()">üîÑ ƒê·ªîI M·∫†NG WIFI (PH√ÅT AP)</button>

<script>
const allPins = ["V1", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10"];
const v10Mapping = {"1":"V3", "2":"V4", "3":"V6", "4":"V5", "5":"V7", "6":"V8"};
const idLookup = {"V1":1,"V2":2,"V3":3,"V4":4,"V5":5,"V6":6,"V7":7,"V8":8,"V9":9,"V10":10};
let customNames = {};
let listV2 = [], listV10 = [];

// --- C·∫§U H√åNH TH√îNG MINH ---
const IP_ESP32 = "192.168.1.200"; // Thay IP th·∫≠t c·ªßa b·∫°n v√†o ƒë√¢y
const WORKER_URL = "https://blynk-token-proxy.tanthanhlttb123.workers.dev";
const DEVICE_NAME = "cay";

// T·ª± ƒë·ªông ki·ªÉm tra xem ƒëang ·ªü nh√† hay ·ªü ngo√†i
const isLocal = window.location.hostname.includes("192.168") || window.location.hostname === "localhost";
const basePrefix = isLocal ? `http://${IP_ESP32}` : WORKER_URL;
// ---------------------------


//---------------------------------------------------------------------
// KH·ªûI T·∫†O DUY NH·∫§T 1 L·∫¶N KHI M·ªû WEB
document.addEventListener("DOMContentLoaded", function() {
    // 1. Ki·ªÉm tra t√∫i t·∫°m (LocalStorage)
    let cachedNames = localStorage.getItem('last_config');
    let cachedV2 = localStorage.getItem('v2_list_cache');
    let cachedV10 = localStorage.getItem('v10_list_cache');

    // N·∫øu t√∫i c√≥ ƒë·ªì th√¨ l·∫•y ra x√†i ngay cho nhanh
    if(cachedNames) customNames = JSON.parse(cachedNames);
    if(cachedV2) listV2 = JSON.parse(cachedV2);
    if(cachedV10) listV10 = JSON.parse(cachedV10);

    // V·∫º L·∫¶N 1 (D√π t√∫i tr·ªëng hay c√≥ ƒë·ªì c≈©ng ph·∫£i v·∫Ω ƒë·ªÉ hi·ªán khung)
    renderUI(); 

    // 2. PH·ª§C H·ªíI D·ªÆ LI·ªÜU (ƒê·ªÅ ph√≤ng b·∫°n v·ª´a x√≥a History)
    // L·∫•y l·∫°i t√™n thi·∫øt b·ªã
    fetch('/get_config?t=' + Date.now()).then(r => r.json()).then(data => {
        if(data && Object.keys(data).length > 0) {
            customNames = data;
            localStorage.setItem('last_config', JSON.stringify(data));
            renderUI(); // V·∫Ω l·∫°i l·∫ßn 2 ƒë·ªÉ c·∫≠p nh·∫≠t t√™n v√† h√¨nh ·∫£nh ƒë√∫ng
        }
    }).catch(()=>{});

    // L·∫•y l·∫°i l·ªãch t∆∞·ªõi V2
    fetch('/tuoi.txt?t=' + Date.now()).then(r => r.json()).then(data => {
        if (Array.isArray(data)) {
            listV2 = data.filter(x => x.a === true).map(x => ({
                t: (x.h < 10 ? "0"+x.h : x.h) + ":" + (x.m < 10 ? "0"+x.m : x.m),
                d: x.d
            }));
            localStorage.setItem('v2_list_cache', JSON.stringify(listV2));
            renderUI(); // V·∫Ω l·∫°i ƒë·ªÉ hi·ªán l·ªãch
        }
    }).catch(()=>{});

    // L·∫•y l·∫°i l·ªãch ƒë√®n V10
    fetch('/den.txt?t=' + Date.now()).then(r => r.text()).then(data => {
        if (data && data.length > 5 && data !== "clear") {
            let items = data.split(', ');
            listV10 = items.map(item => {
                let p = item.trim().split(' ');
                if(p.length >= 4) return { id: p[0].split(':')[1] || p[0], on: p[1], off: p[3] };
                return null;
            }).filter(x => x !== null);
            localStorage.setItem('v10_list_cache', JSON.stringify(listV10));
            renderUI();
        }
    }).catch(()=>{});

    setInterval(updateStatusOnly, 3000);
  
});
  setInterval(function() {
    fetch('/get_notify') // Master s·∫Ω nh·∫£ c√¢u ch·ªØ ·ªü ƒë∆∞·ªùng d·∫´n n√†y
    .then(r => r.text())
    .then(txt => {
        // N·∫øu nh·∫≠n ƒë∆∞·ª£c ch·ªØ v√† kh√¥ng ph·∫£i th√¥ng b√°o tr·ªëng
        if (txt && txt.trim().length > 1) {
            let msg = new SpeechSynthesisUtterance(txt);
            msg.lang = 'vi-VN'; // ƒê·ªçc ti·∫øng Vi·ªát
            msg.rate = 1.0;     // T·ªëc ƒë·ªô ƒë·ªçc b√¨nh th∆∞·ªùng
            window.speechSynthesis.speak(msg);
            console.log("Loa k√™u: " + txt);
        }
    })
    .catch(e => {}); // L·ªù ƒëi n·∫øu m·∫°ng lag ƒë·ªÉ kh√¥ng l√†m ch·∫≠m tr√¨nh duy·ªát
}, 1000); // 1000ms = 1 gi√¢y h·ªèi m·ªôt l·∫ßn

// H√†m chuy√™n ƒëi "sƒÉn" th√¥ng b√°o gi·ªçng n√≥i (1 gi√¢y m·ªôt l·∫ßn)

function renderUI() {
    let h = "";
    allPins.forEach(p => {
        let ver = localStorage.getItem('v_' + p) || '1';
        h += `<div class="device-card">
            <img src="/${p.toUpperCase()}.JPG?v=${ver}" 
            class="device-img" 
            onclick="uploadImg('${p}')" >
            <span id="name-device-${p}" style="cursor:pointer; font-weight:bold; margin-top:5px; display:block;" onclick="editName('${p}')">
                ${customNames[p] || p} ‚úèÔ∏è
            </span>
            <div class="btn-group">
                <button id="on-${p}" class="btn btn-on" onclick="sendCmd('${p}',1)">B·∫¨T</button>
                <button id="off-${p}" class="btn btn-off" onclick="sendCmd('${p}',0)">T·∫ÆT</button>
            </div>
        </div>`;
    });
    document.getElementById('device_list').innerHTML = h;

    let opt = "";
    for (let id in v10Mapping) {
        opt += `<option value="${id}">${customNames[v10Mapping[id]] || ("ƒê√®n " + id)}</option>`;
    }
    document.getElementById('v10_id').innerHTML = opt;

    document.getElementById('v2_list').innerHTML = listV2.map((x, i) => 
        `<div class="list-item"><span><b>${x.t}</b> - T∆∞·ªõi ${x.d}p</span><span class="btn-del" onclick="removeV2(${i})">‚úñ</span></div>`
    ).join('') || '<div style="color:#ccc;text-align:center">Tr·ªëng</div>';

    document.getElementById('v10_list').innerHTML = listV10.map((x, i) => 
        `<div class="list-item"><span><b>${customNames[v10Mapping[x.id]] || 'ƒê√®n '+x.id}:</b> ${x.on} ‚ûî ${x.off}</span><span class="btn-del" onclick="removeV10(${i})">‚úñ</span></div>`
    ).join('') || '<div style="color:#ccc;text-align:center">Tr·ªëng</div>';
}

function sendCmd(p, v) {
    let status = (v == 1) ? "ON" : "OFF";
    
    // T·∫°o link th√¥ng minh
    let finalUrl = isLocal 
        ? `${basePrefix}/cmd?id=${idLookup[p]}&val=${status}`
        : `${basePrefix}?action=update&pin=${p}&value=${v}&device=${DEVICE_NAME}`;

    fetch(finalUrl, { mode: 'no-cors' });

    if ('speechSynthesis' in window) {
        window.speechSynthesis.speak(new SpeechSynthesisUtterance((v == 1 ? "B·∫≠t " : "T·∫Øt ") + (customNames[p] || p)));
    }
}
function updateStatusOnly() {
      // N·∫øu ƒëi xa th√¨ l·∫•y tr·∫°ng th√°i t·ª´ Worker, ·ªü nh√† l·∫•y t·ª´ ESP32
    let statusUrl = isLocal ? `${basePrefix}/get_status` : `${basePrefix}?action=get_all&device=${DEVICE_NAME}`;

     fetch(statusUrl).then(r => r.json()).then(data => {
        for (let p in data) {
            let onBtn = document.getElementById(`on-${p}`);
            let offBtn = document.getElementById(`off-${p}`);
            if(onBtn && offBtn) {
                // N·∫øu data[p] == 1 (Thi·∫øt b·ªã ƒëang m·ªü)
                if (data[p] == 1) {
                    onBtn.className = "btn btn-on active-on";   // N√∫t ON s√°ng xanh ƒë·∫≠m
                    offBtn.className = "btn btn-off";           // N√∫t OFF x√°m nh·∫°t
                } 
                // N·∫øu data[p] == 0 (Thi·∫øt b·ªã ƒëang t·∫Øt)
                else {
                    onBtn.className = "btn btn-on";             // N√∫t ON xanh nh·∫°t
                    offBtn.className = "btn btn-off active-off"; // N√∫t OFF s√°ng x√°m l√¥ng chu·ªôt
                }
            }
        }
    }).catch(e => console.log("Ch∆∞a k·∫øt n·ªëi ƒë∆∞·ª£c thi·∫øt b·ªã"));
}

function addV2() {
    let t = document.getElementById('v2_t').value;
    let d = document.getElementById('v2_d').value;
    
    if(t && d) {
        // TH√äM ƒêO·∫†N N√ÄY: Ki·ªÉm tra n·∫øu ƒë√£ ƒë·ªß 6 l·∫ßn th√¨ b√°o l·ªói
        if (listV2.length >= 6) {
            alert("‚ö†Ô∏è H·ªá th·ªëng ch·ªâ h·ªó tr·ª£ t·ªëi ƒëa 6 l·∫ßn t∆∞·ªõi/ng√†y ƒë·ªÉ ƒë·∫£m b·∫£o ·ªïn ƒë·ªãnh!");
            return; // D·ª´ng l·∫°i, kh√¥ng cho push v√†o list n·ªØa
        }
        if (d > 255) {
            alert("‚ö†Ô∏è S·ªë ph√∫t t∆∞·ªõi t·ªëi ƒëa l√† 255 ph√∫t (4h15p)!");
            return;
        }
        
        
        listV2.push({t, d}); 
        renderUI(); 
    }
}

function saveV2(btn) {
    let full = [];
    for(let i=0; i<6; i++) {
        if(listV2[i]) {
            let p = listV2[i].t.split(':');
            full.push({id:i+1, h:parseInt(p[0]), m:parseInt(p[1]), d:parseInt(listV2[i].d), a:true});
        } else {
            full.push({id:i+1, h:0, m:0, d:0, a:false});
        }
    }
    localStorage.setItem('v2_list_cache', JSON.stringify(listV2));
    fetch('/irrigation?d=' + encodeURIComponent(JSON.stringify(full))).then(() => {
        btn.innerText = "‚úÖ ƒê√É L∆ØU!"; btn.style.background = "#2ecc71";
        setTimeout(() => { btn.innerText = "G·ª¨I & L∆ØU L·ªäCH T∆Ø·ªöI"; btn.style.background = ""; }, 2000);
    });
}

function addV10() {
    let id = document.getElementById('v10_id').value;
    let on = document.getElementById('v10_on').value;
    let off = document.getElementById('v10_off').value;
    if(on && off) {
        listV10 = listV10.filter(x => x.id !== id);
        listV10.push({id, on, off});
        renderUI();
    }
}

function saveV10(btn) {
    localStorage.setItem('v10_list_cache', JSON.stringify(listV10));
    let dataStr = listV10.map(s => `id:${s.id} ${s.on} true ${s.off} false`).join(', ');
    fetch('/schedule_save?d=' + encodeURIComponent(dataStr));
    listV10.forEach(s => {
        fetch(`/cmd_sched?pin=${v10Mapping[s.id]}&on=${s.on}&off=${s.off}`);
    });
    btn.innerText = "‚úÖ ƒê√É L∆ØU!"; btn.style.background = "#2ecc71";
    setTimeout(() => { btn.innerText = "G·ª¨I & L∆ØU L·ªäCH ƒê√àN"; btn.style.background = ""; }, 2000);
}
function removeV2(i) {
    if(confirm("B·∫°n mu·ªën x√≥a l·ªãch t∆∞·ªõi n√†y?")) {
        // 1. X√≥a kh·ªèi danh s√°ch t·∫°m tr√™n web
        listV2.splice(i, 1);
        renderUI();
        
        // 2. C·∫≠p nh·∫≠t l·∫°i v√†o b·ªô nh·ªõ m√°y (LocalStorage)
        localStorage.setItem('v2_list_cache', JSON.stringify(listV2));

        // 3. RA L·ªÜNH CHO CHIP GHI ƒê√à FILE M·ªöI (X√≥a vƒ©nh vi·ªÖn trong Flash)
        let full = [];
        for(let j=0; j<6; j++) {
            if(listV2[j]) {
                let p = listV2[j].t.split(':');
                full.push({id:j+1, h:parseInt(p[0]), m:parseInt(p[1]), d:parseInt(listV2[j].d), a:true});
            } else {
                full.push({id:j+1, h:0, m:0, d:0, a:false});
            }
        }
        fetch('/irrigation?d=' + encodeURIComponent(JSON.stringify(full)));
    }
}

function removeV10(i) {
    if(confirm("B·∫°n mu·ªën x√≥a l·ªãch ƒë√®n n√†y?")) {
        let item = listV10[i];
        let pinName = v10Mapping[item.id]; 

        // 1. Ra l·ªánh cho Slave ng·ª´ng ch·∫°y l·ªãch n√†y
        fetch(`/cmd_sched_off?pin=${pinName}`);

        // 2. X√≥a kh·ªèi danh s√°ch t·∫°m tr√™n web v√† c·∫≠p nh·∫≠t LocalStorage
        listV10.splice(i, 1);
        localStorage.setItem('v10_list_cache', JSON.stringify(listV10));
        renderUI();

        // 3. RA L·ªÜNH CHO MASTER GHI ƒê√à FILE DEN.TXT M·ªöI
        // N·∫øu kh√¥ng c√≤n l·ªãch n√†o th√¨ g·ª≠i ch·ªØ "clear" ƒë·ªÉ x√≥a s·∫°ch file
        let dataStr = listV10.length > 0 
            ? listV10.map(s => `id:${s.id} ${s.on} true ${s.off} false`).join(', ') 
            : "clear";
        
        fetch('/schedule_save?d=' + encodeURIComponent(dataStr));
    }
}

function editName(p) {
    let oldName = (customNames[p] || p);
    let newName = prompt("T√™n m·ªõi:", oldName);
    if (newName && newName !== oldName) {
        fetch(`/set_name?pin=${p}&name=${encodeURIComponent(newName)}`).then(() => {
            customNames[p] = newName;
            localStorage.setItem('last_config', JSON.stringify(customNames));
            renderUI();
        });
    }
}

function uploadImg(pin) {
    let input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
    input.onchange = e => {
        let file = e.target.files[0]; if (!file) return;
        let reader = new FileReader();
        reader.onload = event => {
            let img = new Image();
            img.onload = () => {
                let canvas = document.createElement('canvas');
                canvas.width = 500; canvas.height = img.height * (500 / img.width);
                canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(blob => {
                    let formData = new FormData(); formData.append("image", blob, pin.toUpperCase() + ".JPG");
                    fetch('/upload?t=' + Date.now(), { method: 'POST', body: formData }).then(r => {
                        if(r.ok) {
                            let v = Date.now(); localStorage.setItem('v_' + pin, v);
                            const imgEl = document.querySelector(`img[onclick*="${pin}"]`);
                            if(imgEl) { imgEl.src = `/${pin.toUpperCase()}.JPG?v=${v}`;  }
                        }
                    });
                }, 'image/jpeg', 0.6);
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };
    input.click();
}

function phatWifiConfig() {
    let code = prompt("NH·∫¨P M√É X√ÅC TH·ª∞C (Security Code):");
    if (code == null || code == "") return;

    // G·ª≠i y√™u c·∫ßu ƒë·∫øn ESP32
    fetch('/phat_wifi_ap?auth_code=' + encodeURIComponent(code))
    .then(response => {
        if (!response.ok) throw new Error('M·∫•t k·∫øt n·ªëi');
        return response.text();
    })
    .then(txt => {
        if (txt.includes("M√É ƒê√öNG")) {
            // Hi·ªÉn th·ªã th√¥ng b√°o ngay l·∫≠p t·ª©c tr∆∞·ªõc khi chip ng·∫Øt m·∫°ng
            alert("‚úÖ X√ÅC TH·ª∞C TH√ÄNH C√îNG!\n\n1. Chip ƒëang chuy·ªÉn sang ch·∫ø ƒë·ªô ph√°t WiFi.\n2. Vui l√≤ng t√¨m WiFi t√™n: 'Sua_WiFi_ThietBi'\n3. Sau khi c√†i xong, thi·∫øt b·ªã s·∫Ω t·ª± quay l·∫°i IP .200");
        } else {
            alert("‚ùå M√£ s·ªë sai r·ªìi b·∫°n ∆°i! Vui l√≤ng th·ª≠ l·∫°i.");
        }
    })
    .catch(err => {
        // Tr∆∞·ªùng h·ª£p n√†y th∆∞·ªùng x·∫£y ra khi chip ng·∫Øt WiFi ƒë·ªÉ ph√°t AP qu√° nhanh
        alert("üîÑ ƒêang chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô... \nH√£y ki·ªÉm tra danh s√°ch WiFi tr√™n ƒëi·ªán tho·∫°i c·ªßa b·∫°n sau 5 gi√¢y.");
    });
}

// H·ªèi th√¥ng b√°o nhanh h∆°n (1 gi√¢y m·ªôt l·∫ßn) ƒë·ªÉ kh√¥ng b·ªè l·ª° gi·ªçng n√≥i

//hoan hao 111
</script>
</body>
</html>
