<!DOCTYPE html>
<html>
<head>
  <title>Điều khiển 1 ESP8266 qua MQTT</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    button {
      width: 100px;
      height: 50px;
      font-size: 18px;
      border-radius: 10px;
      background-color: #4CAF50;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #3e8e41;
    }
  </style>
</head>
<body>
  <h1>Điều khiển 1 ESP8266 qua MQTT</h1>
  <button onclick="sendCommand('ON')">Bật</button>
  <button onclick="sendCommand('OFF')">Tắt</button>
  <div id="status"></div>

 


  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<script>
    // Cấu hình chuẩn WSS
    var mqttBroker = "broker.hivemq.com"; 
    var mqttPort = 8884; 
    var topicCommand = "tanthanhlttb123/control"; 
    var topicStatus = "tanthanhlttb123/status"; 
    
    // Khởi tạo Client (KHÔNG GỌI CONNECT Ở ĐÂY)
    var client = new Paho.MQTT.Client(mqttBroker, mqttPort, "web-client-" + parseInt(Math.random() * 1000)); 

    // Mặc định trạng thái khi chưa làm gì
    document.getElementById("status").innerHTML = "Trạng thái: CHƯA KẾT NỐI (Hãy nhấn nút)";


    // Các hàm xử lý sự kiện (Giữ nguyên)
    client.onConnectionLost = function(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("Mất kết nối:" + responseObject.errorMessage);
        }
        document.getElementById("status").innerHTML = "Trạng thái: ĐÃ NGẮT KẾT NỐI";
    }

    client.onMessageArrived = function(message) {
        if (message.destinationName === topicStatus) {
            var payload = message.payloadString;
            console.log("ACK nhận được: " + payload);
            
            if (payload === "OK") {
                document.getElementById("status").innerHTML = "Lệnh đã thực hiện: ✅ **THÀNH CÔNG**";
            } else if (payload === "FAIL") {
                document.getElementById("status").innerHTML = "Lệnh đã thực hiện: ❌ **THẤT BẠI**";
            } else {
                document.getElementById("status").innerHTML = "Trạng thái ESP8266: " + payload;
            }
        }
    }

    // HÀM KẾT NỐI MQTT
    function connectToMqtt() {
        if (client.isConnected()) {
            // Đã kết nối, không làm gì cả
            return true;
        }

        // Bắt đầu kết nối
        document.getElementById("status").innerHTML = "Trạng thái: ĐANG KẾT NỐI...";
        
        client.connect({
            onSuccess: function() {
                console.log("Connected to MQTT broker");
                client.subscribe(topicStatus, { qos: 1 }); 
                document.getElementById("status").innerHTML = "Trạng thái: KẾT NỐI THÀNH CÔNG";
            },
            onFailure: function(responseObject) {
                console.log("Kết nối thất bại: " + responseObject.errorMessage);
                document.getElementById("status").innerHTML = "Trạng thái: KẾT NỐI LỖI";
            },
            useSSL: true, 
        });

        return false;
    }


    // HÀM GỬI LỆNH (GỌI KẾT NỐI NẾU CHƯA KẾT NỐI)
    function sendCommand(command) {
        if (!client.isConnected()) {
            // Nếu chưa kết nối, thử kết nối trước.
            connectToMqtt();
            // Không gửi lệnh ngay, đợi lần nhấn nút tiếp theo
            document.getElementById("status").innerHTML = "Trạng thái: ĐANG KẾT NỐI... (Nhấn lại sau)";
            return; 
        }

        // Đã kết nối, tiến hành gửi lệnh
        var message = new Paho.MQTT.Message(command);
        message.destinationName = topicCommand;
        message.qos = 1; 

        client.send(message); 
        
        document.getElementById("status").innerHTML = "Đang gửi lệnh " + command + "...";
    }

    // CHÚ Ý: ĐÃ BỎ HÀM connect() RA KHỎI PHẦN KHỞI TẠO.
</script>

</body>
</html>