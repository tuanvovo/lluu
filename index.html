<!DOCTYPE html>
<html lang="vi">
<head>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/628/628283.png">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">


    <title>H·ªá Th·ªëng Th√¥ng Minh</title>
    <style>
        /* T√¨m v√† thay th·∫ø c√°c d√≤ng t∆∞∆°ng ·ª©ng trong :root v√† c√°c class btn */
:root { 
    --bg: #f0f2f5; 
    --primary: #1a73e8; 
    --on: #2ecc71;
    --on-active: #2ecc71;   /* Xanh ƒë·∫≠m khi B·∫¨T */
    --on-dim: #e8f5e9;      /* Xanh nh·∫°t khi ch∆∞a B·∫¨T */
    --off-active: #7f8c8d;  /* X√°m l√¥ng chu·ªôt ƒë·∫≠m khi T·∫ÆT */
    --off-dim: #f5f5f5;     /* X√°m l√¥ng chu·ªôt nh·∫°t khi ch∆∞a T·∫ÆT */
}
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .device-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; text-align: center; padding: 10px; display: flex; flex-direction: column; }
        .device-img { width: 100%; height: 100px; object-fit: cover; border-radius: 5px; cursor: pointer; background: #eee; transition: 0.3s; }
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .btn { border: none; padding: 8px; border-radius: 5px; cursor: pointer; flex: 1; font-weight: bold; font-size: 12px; }
        /* N√∫t B·∫¨T m·∫∑c ƒë·ªãnh */
.btn-on { background: var(--on-dim); color: var(--on-active); border: 1px solid var(--on-active); }
/* N√∫t T·∫ÆT m·∫∑c ƒë·ªãnh */
.btn-off { background: var(--off-dim); color: var(--off-active); border: 1px solid var(--off-active); }
.active-on { background: var(--on-active) !important; color: white !important; }
/* Khi ƒëang ·ªü tr·∫°ng th√°i B·∫¨T (Active) */
/* Khi ƒëang ·ªü tr·∫°ng th√°i T·∫ÆT (Active) */

 .active-off { background: var(--off-active) !important; color: white !important; }      
       
        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
        .list-box { border: 1px solid #eee; padding: 10px; border-radius: 5px; margin-bottom: 10px; min-height: 40px; background: #fafafa; }
        .list-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; font-size: 13px; }
        .btn-del { color: red; cursor: pointer; font-weight: bold; padding: 0 10px; }
        .btn-save { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
   
         .device-img:active {
    transform: scale(0.95);
    opacity: 0.8;
}
   </style>
</head>
<body>

    <div class="card">
        <h3>ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã</h3>
        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px; background: #e8f0fe; padding: 8px; border-radius: 8px;">
    <input type="checkbox" id="voice_active" checked style="width: 18px; height: 18px;">
    <label for="voice_active" style="font-size: 13px; font-weight: bold; color: #1a73e8;">üîä Ph√°t th√¥ng b√°o gi·ªçng n√≥i</label>
</div>
        <div id="device_list" class="grid-container"></div>
    </div>


    <div class="card" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 20px; background: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center; gap: 10px;">
        <div id="status-indicator" style="width: 12px; height: 12px; background: #95a5a6; border-radius: 50%;"></div>
        <span style="font-weight: bold; color: #2c3e50;">TR·∫†NG TH√ÅI H·ªÜ TH·ªêNG</span>
    </div>
    
    <button onclick="updateStatusOnly()" class="btn-save" style="width: auto; margin: 0; padding: 8px 20px; background: #3498db; display: flex; align-items: center; gap: 8px;">
        <span>üîÑ ƒê·ªíNG B·ªò NGAY</span>
    </button>
</div>

    <div class="card">
        
        <h3>L·ªãch T∆∞·ªõi Lan (V2)</h3>
        
        <div class="input-group">
            <input type="time" id="v2_t">
            <input type="number" id="v2_d" placeholder="Ph√∫t">
            <button onclick="addV2()" style="padding:0 15px;">+</button>
        </div>
        <div id="v2_list" class="list-box"></div>
        <button class="btn-save" style="background: var(--on)" onclick="saveV2(this)">G·ª¨I & L∆ØU L·ªäCH T∆Ø·ªöI</button>
    </div>

    <div class="card">
        <h3>L·∫≠p l·ªãch ƒê√®n (V0)</h3>
        <select id="v10_id"></select>
        <div class="input-group" style="margin-top:10px;">
            <input type="time" id="v10_on">
            <input type="time" id="v10_off">
            <button onclick="addV10()" style="padding:0 15px;">+</button>
        </div>
        <div id="v10_list" class="list-box"></div>
        <button class="btn-save" >G·ª¨I & L∆ØU L·ªäCH ƒê√àN</button>
    </div>

    <button class="btn-save" style="background: #e67e22; margin-bottom: 30px;" onclick="phatWifiConfig()">üîÑ ƒê·ªîI M·∫†NG WIFI (PH√ÅT AP)</button>

<script>



// Th√™m V11 v√†o cu·ªëi danh s√°ch n√†y

const allPins = ["V1", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12"];
const v10Mapping = {
    "1":"V3", "2":"V4", "3":"V5", "4":"V6", "5":"V7", 
    "6":"V8", "7":"V9", "8":"V10", "9":"V11", "10":"V12" 
};
const idLookup = {"V1":1,"V2":2,"V3":3,"V4":4,"V5":5,"V6":6,"V7":7,"V8":8,"V9":9,"V10":10,"V11":11,"V12":12};



let customNames = {};
let listV2 = [], listV10 = [], listV0 = [];

// --- C·∫§U H√åNH TH√îNG MINH ---

const segment = "1"; // ƒê·ªãnh nghƒ©a s·ªë segment ƒë·ªÉ tr√°nh l·ªói fetch
const WORKER_URL = "https://blynk-token-proxy.tanthanhlttb123.workers.dev";
const DEVICE_NAME = "cay";

const isLocal = window.location.hostname.includes("192.168") || window.location.hostname === "localhost";



//---------------------------------------------------------------------
document.addEventListener("DOMContentLoaded", function() {
    // 1. L·∫§Y D·ªÆ LI·ªÜU T·ª™ B·ªò NH·ªö T·∫†M (CACHE)
    let cachedNames = localStorage.getItem('last_config');
    let cachedV2 = localStorage.getItem('v2_list_cache');
    let cachedV10 = localStorage.getItem('v10_list_cache');

    if(cachedNames) customNames = JSON.parse(cachedNames);
    if(cachedV2) listV2 = JSON.parse(cachedV2);
    if(cachedV10) listV10 = JSON.parse(cachedV10);

    // 2. V·∫º GIAO DI·ªÜN L·∫¶N ƒê·∫¶U
    renderUI(); 
   // updateStatusOnly();
    // 3. N·∫æU ·ªû NH√Ä (ISLOCAL), L·∫§Y T√äN THI·∫æT B·ªä M·ªöI NH·∫§T T·ª™ ESP32
    if (isLocal) {
        fetch('/get_config?t=' + Date.now()).then(r => r.json()).then(data => {
            if(data && Object.keys(data).length > 0) {
                customNames = data;
                localStorage.setItem('last_config', JSON.stringify(data));
                renderUI(); // V·∫Ω l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t t√™n m·ªõi
            }
        }).catch(()=>{});
    }

    // 4. ƒê·ªíNG B·ªò TR·∫†NG TH√ÅI N√öT B·∫§M NGAY L·∫¨P T·ª®C KHI V·ª™A M·ªû WEB
    updateStatusOnly();

    // 5. THI·∫æT L·∫¨P V√íNG L·∫∂P TH√îNG MINH (CH·ªà CH·∫†Y KHI ƒêANG M·ªû TAB)
 // setInterval(() => {
        // Ch·ªâ t·ªën pin/Cloud khi b·∫°n ƒëang nh√¨n v√†o trang web
   //    if (!document.hidden) {
//updateStatusOnly();
      //      console.log("ƒêang t·ª± ƒë·ªông ƒë·ªìng b·ªô tr·∫°ng th√°i...");
   //  }
//  }, 10000); // 10 gi√¢y m·ªôt l·∫ßn l√† ƒë·∫πp cho Web Git
});
// H√†m l·∫•y th√¥ng b√°o gi·ªçng n√≥i
setInterval(function() {
    if (!isLocal) return;
    fetch('/get_notify').then(r => r.text()).then(txt => {
        if (txt && txt.trim().length > 1) {
            let msg = new SpeechSynthesisUtterance(txt);
            msg.lang = 'vi-VN';
            window.speechSynthesis.speak(msg);
        }
    }).catch(e => {});
}, 1000);

function renderUI() {
    let h = "";
    allPins.forEach(p => {
        let savedImg = localStorage.getItem('img_' + p);
        let imgSrc = "";
        
        if (savedImg) {
            imgSrc = savedImg; // ∆Øu ti√™n ·∫£nh n√©t trong m√°y
        } else if (isLocal) {
            imgSrc = `/${p.toUpperCase()}.JPG?t=${Date.now()}`; // L·∫•y t·ª´ ESP32 n·∫øu ·ªü nh√†
        }else {
    // D√πng ·∫£nh icon m·∫∑c ƒë·ªãnh thay v√¨ link placeholder b·ªã l·ªói
    imgSrc = "https://cdn-icons-png.flaticon.com/512/628/628283.png"; 
}

        h += `<div class="device-card">
            <img src="${imgSrc}" id="img-tag-${p}"
            class="device-img" 
            onerror="this.src='https://via.placeholder.com/150/cccccc/ffffff?text=No+Image'"
            onclick="uploadImg('${p}')" >
            <span id="name-device-${p}" style="cursor:pointer; font-weight:bold; margin-top:5px; display:block;" onclick="editName('${p}')">
                ${customNames[p] || p} ‚úèÔ∏è
            </span>
            <div class="btn-group">
                <button id="on-${p}" class="btn btn-on" onclick="sendCmd('${p}',1)">B·∫¨T</button>
                <button id="off-${p}" class="btn btn-off" onclick="sendCmd('${p}',0)">T·∫ÆT</button>
            </div>
        </div>`;
    });
    document.getElementById('device_list').innerHTML = h;

    // Load options cho V10
    let opt = "";
    for (let id in v10Mapping) {
        opt += `<option value="${id}">${customNames[v10Mapping[id]] || ("ƒê√®n " + id)}</option>`;
    }
    let v0Select = document.getElementById('v10_id');
    if(v0Select) v0Select.innerHTML = opt;

    document.getElementById('v2_list').innerHTML = listV2.map((x, i) => 
        `<div class="list-item"><span><b>${x.t}</b> - T∆∞·ªõi ${x.d}p</span><span class="btn-del" onclick="removeV2(${i})">‚úñ</span></div>`
    ).join('') || '<div style="color:#ccc;text-align:center">Tr·ªëng</div>';

    // C·∫≠p nh·∫≠t c√°ch hi·ªÉn th·ªã danh s√°ch V10
document.getElementById('v10_list').innerHTML = listV10.map((x, i) => {
    let tenPhong = customNames[v10Mapping[x.id]] || 'ƒê√®n ' + x.id;
    return `
    <div class="list-item" style="display: flex; align-items: center; justify-content: space-between; background: #fff; margin-bottom: 5px; padding: 8px; border-radius: 5px; border-left: 4px solid var(--primary);">
        <div style="flex: 1;">
            <b style="color:var(--primary)">${tenPhong}:</b> 
            <span style="font-size: 12px;">${x.on} ‚ûî ${x.off}</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="saveSingleV10(${i}, this)" style="background: #2ecc71; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">G·ª¨I</button>
            
            <span class="btn-del" onclick="removeV10(${i})" style="color: #e74c3c; cursor: pointer; font-weight: bold; padding: 0 5px;">‚úñ</span>
        </div>
    </div>`;
}).join('') || '<div style="color:#ccc;text-align:center">Ch∆∞a c√≥ l·ªãch ƒë∆∞·ª£c t·∫°o</div>';
}

// --- H√ÄM CH·ªåN ·∫¢NH SI√äU N√âT ---
function uploadImg(pin) {
    let input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = e => {
        let file = e.target.files[0];
        if (!file) return;

        let reader = new FileReader();
        reader.onload = event => {
            let img = new Image();
            img.onload = () => {
                let canvas = document.createElement('canvas');
                let ctx = canvas.getContext('2d');

                // 1. L∆ØU B·∫¢N N√âT V√ÄO LOCALSTORAGE (D√πng cho Web Git)
                let MAX_WEB = 600; 
                let scaleWeb = MAX_WEB / img.width;
                canvas.width = MAX_WEB;
                canvas.height = img.height * scaleWeb;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                let highResData = canvas.toDataURL('image/jpeg', 0.8);
                try {
                    localStorage.setItem('img_' + pin, highResData);
                    document.getElementById('img-tag-' + pin).src = highResData;
                } catch(e) { console.log("B·ªô nh·ªõ ƒë·∫ßy, kh√¥ng th·ªÉ l∆∞u ·∫£nh n√©t"); }

                // 2. N√âN 20KB G·ª¨I ESP32 (Ch·ªâ g·ª≠i khi ·ªü nh√† - isLocal)
                if (isLocal) {
                    let MAX_ESP = 300;
                    let scaleESP = MAX_ESP / img.width;
                    canvas.width = MAX_ESP;
                    canvas.height = img.height * scaleESP;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob(blob => {
                        let formData = new FormData();
                        formData.append("image", blob, pin.toUpperCase() + ".JPG");
                        fetch('/upload', { method: 'POST', body: formData });
                    }, 'image/jpeg', 0.5);
                }
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };
    input.click();
}

// C√°c h√†m b·ªï tr·ª£ gi·ªØ nguy√™n
function sendCmd(p, v) {
    let status = (v == 1) ? "ON" : "OFF";
    let pinID = p.replace("V", ""); // L·∫•y s·ªë 1 t·ª´ "V1"

    let finalUrl = "";
    {
        // G·ª≠i qua Worker chu·∫©n action=update
        finalUrl = `${WORKER_URL}?action=update&pin=${p}&value=${v}&device=${DEVICE_NAME}`;
    }

    console.log("ƒêang g·ª≠i t·ªõi:", finalUrl);
    fetch(finalUrl, { mode: 'no-cors' });

    // C·∫≠p nh·∫≠t n√∫t b·∫•m
    document.getElementById(`on-${p}`).className = (v==1) ? "btn btn-on active-on" : "btn btn-on";
    document.getElementById(`off-${p}`).className = (v==0) ? "btn btn-off active-off" : "btn btn-off";
}

// H√†m n√†y ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t v√† ƒë·ªïi m√†u c√°i ƒë√®n nh·ªè tr√™n thanh tr·∫°ng th√°i


// T·ª∞ ƒê·ªòNG CH·∫†Y KHI M·ªû WEB1
async function saveSingleV10(index, btn) {
    let item = listV10[index];
    if(!item) return;

    // L·∫•y ID th·ª±c t·∫ø (v√≠ d·ª•: V3 l·∫•y s·ªë 3)
    let realId = v10Mapping[item.id].replace("V", "");
    
    // T·∫°o chu·ªói ƒë√∫ng ƒë·ªãnh d·∫°ng Master ƒëang ƒë·ª£i
    let dataStr = `id:${realId} ${item.on} true ${item.off} false`;

    btn.innerText = "‚è≥";
    btn.disabled = true;

    const url = `${WORKER_URL}?action=update&pin=V0&value=${encodeURIComponent(dataStr)}&device=cay`;

    try {
        await fetch(url);
        btn.innerText = "‚úÖ OK";
        btn.style.background = "#95a5a6";
        setTimeout(() => { 
            btn.innerText = "G·ª¨I"; 
            btn.style.background = "#2ecc71";
            btn.disabled = false;
        }, 2000);
    } catch (err) {
        alert("L·ªói k·∫øt n·ªëi!");
        btn.innerText = "TH·ª¨ L·∫†I";
        btn.disabled = false;
    }
}

function addV2() {
    let t = document.getElementById('v2_t').value;
    let d = document.getElementById('v2_d').value;
    if(t && d) {
        if (listV2.length >= 6) return alert("T·ªëi ƒëa 6 l·∫ßn!");
        listV2.push({t, d}); renderUI(); 
    }
    
    
}


function updateStatusOnly() {
    const indicator = document.getElementById('status-indicator');
    if(indicator) indicator.style.background = "#f1c40f"; 

   
    let statusUrl = `${WORKER_URL}?action=get_all&device=cay`;
    // G·ª≠i chu·ªói l·ªãch V2 (T∆∞·ªõi c√¢y) ho·∫∑c V0 (ƒê√®n) qua Worker ƒë·ªÉ l∆∞u l√™n Blynk Cloud
  
    
    
    fetch(statusUrl)
    .then(r => r.text()) // ƒê·ªçc d·ªØ li·ªáu th√¥ (d·∫°ng ch·ªØ) ƒë·ªÉ ki·ªÉm tra tr∆∞·ªõc
    .then(text => {
        try {
            // Ch·ªâ khi n√†o d·ªØ li·ªáu b·∫Øt ƒë·∫ßu b·∫±ng d·∫•u "{" th√¨ m·ªõi x·ª≠ l√Ω ƒë·ªïi m√†u
            if (text.trim().startsWith('{')) {
                const data = JSON.parse(text);
                console.log("D·ªØ li·ªáu chu·∫©n:", data);
                if(indicator) indicator.style.background = "#2ecc71";
                
                for (let p in data) {
                    let onBtn = document.getElementById(`on-${p}`);
                    let offBtn = document.getElementById(`off-${p}`);
                    if(onBtn && offBtn) {
                        let val = String(data[p]); 
                        if (val === "1" || val === "true") {
                            onBtn.className = "btn btn-on active-on";
                            offBtn.className = "btn btn-off";
                        } else {
                            onBtn.className = "btn btn-on";
                            offBtn.className = "btn btn-off active-off";
                        }
                    }
                }
            } else {
                // N·∫øu Worker tr·∫£ v·ªÅ ch·ªØ "L·ªánh kh√¥ng..." th√¨ b√°o l·ªói nh∆∞ng kh√¥ng l√†m treo web
                console.log("Worker ch∆∞a tr·∫£ v·ªÅ JSON, ƒëang ch·ªù...:", text);
                if(indicator) indicator.style.background = "#e67e22"; 
            }
        } catch (err) {
            console.log("L·ªói ƒë·ªãnh d·∫°ng d·ªØ li·ªáu:", err);
        }
    })
    .catch(e => {
        if(indicator) indicator.style.background = "#e74c3c"; 
    });
}
function saveV2(btn) {
    let full = [];
    for(let i=0; i<6; i++) {
        if(listV2[i]) {
            let p = listV2[i].t.split(':');
            full.push({id:i+1, h:parseInt(p[0]), m:parseInt(p[1]), d:parseInt(listV2[i].d), a:true});
        } else {
            full.push({id:i+1, h:0, m:0, d:0, a:false});
        }
    }
    localStorage.setItem('v2_list_cache', JSON.stringify(listV2));

    // S·ª¨A T·∫†I ƒê√ÇY: D√πng basePrefix ƒë·ªÉ g·ª≠i ƒë√∫ng ch·ªó
    
    // G·ª≠i chu·ªói l·ªãch V2 (T∆∞·ªõi c√¢y) ho·∫∑c V0 (ƒê√®n) qua Worker ƒë·ªÉ l∆∞u l√™n Blynk Cloud
    let url = `${WORKER_URL}?action=update&pin=V2&value=${encodeURIComponent(JSON.stringify(full))}&device=cay`;
    
    fetch(url).then(() => {
        btn.innerText = "‚úÖ ƒê√É L∆ØU!"; 
        btn.style.background = "#2ecc71";
        setTimeout(() => { btn.innerText = "G·ª¨I & L∆ØU L·ªäCH T∆Ø·ªöI"; btn.style.background = ""; }, 2000);
    }).catch(e => alert("Kh√¥ng g·ª≠i ƒë∆∞·ª£c l·ªãch, h√£y ki·ªÉm tra k·∫øt n·ªëi v·ªõi ESP32!"));
}

function addV10() {
    let id = document.getElementById('v10_id').value;
    let on = document.getElementById('v10_on').value;
    let off = document.getElementById('v10_off').value;
    if(on && off) {
        listV10 = listV10.filter(x => x.id !== id);
        listV10.push({id, on, off}); renderUI();
    }
}



function removeV2(i) {
    if(confirm("X√≥a l·ªãch?")) { listV2.splice(i, 1); renderUI(); saveV2({innerText:""}); }
}

function removeV10(i) {
    let item = listV10[i];
    if(confirm(`X√≥a l·ªãch ${customNames[v10Mapping[item.id]] || 'n√†y'}?`)) {
        let realId = v10Mapping[item.id].replace("V", "");
        
        // G·ª≠i l·ªánh ƒë·∫∑c bi·ªát ƒë·ªÉ Slave bi·∫øt ƒë∆∞·ªùng m√† x√≥a l·ªãch
        let cmdDelete = `id:${realId} DELETE`; 

        const url = `${WORKER_URL}?action=update&pin=V0&value=${encodeURIComponent(cmdDelete)}&device=cay`;
        
        fetch(url).then(() => {
            listV10.splice(i, 1); // X√≥a kh·ªèi giao di·ªán
            localStorage.setItem('v10_list_cache', JSON.stringify(listV10));
            renderUI();
        });
    }
}

async function deleteAllSchedules() {
    if (!confirm("‚ö†Ô∏è B·∫°n c√≥ mu·ªën X√ìA T·∫§T C·∫¢ l·ªãch ƒë√®n kh√¥ng?")) return;

    // G·ª≠i l·ªánh CLEAR_DEN l√™n V10 qua Worker
    const deleteUrl = `${WORKER_URL}?action=update&pin=V10&value=CLEAR_DEN&device=cay`;
    
    try {
        const res = await fetch(deleteUrl);
        if(res.ok) {
            alert("‚úÖ ƒê√£ g·ª≠i l·ªánh x√≥a l·ªãch ƒë√®n th√†nh c√¥ng!");
            // X√≥a s·∫°ch d·ªØ li·ªáu t·∫°m tr√™n tr√¨nh duy·ªát
            localStorage.removeItem('savedSchedules'); 
            location.reload(); 
        }
    } catch (err) {
        alert("L·ªói k·∫øt n·ªëi Worker!");
    }
}
/*
function editName(p) {
    let oldName = (customNames[p] || p);
    let newName = prompt("T√™n m·ªõi:", oldName);
    if (newName && newName !== oldName) {
        fetch(`/set_name?pin=${p}&name=${encodeURIComponent(newName)}`).then(() => {
            customNames[p] = newName;
            localStorage.setItem('last_config', JSON.stringify(customNames));
            renderUI();
        });
    }
}
/*
function editName(p) {
    let oldName = (customNames[p] || p);
    let newName = prompt("Nh·∫≠p t√™n m·ªõi cho " + p + ":", oldName);
    
    if (newName && newName !== oldName) {
        // B∆Ø·ªöC 1: C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c v√†o b·ªô nh·ªõ tr√¨nh duy·ªát (localStorage)
        // Vi·ªác n√†y gi√∫p t√™n hi·ªÉn th·ªã ƒë√∫ng ngay c·∫£ khi kh√¥ng c√≥ k·∫øt n·ªëi t·ªõi chip
        customNames[p] = newName;
        localStorage.setItem('last_config', JSON.stringify(customNames));
        renderUI(); // V·∫Ω l·∫°i giao di·ªán ƒë·ªÉ hi·ªán t√™n m·ªõi

        // B∆Ø·ªöC 2: G·ª≠i t√™n m·ªõi n√†y l√™n Cloud (Worker) ƒë·ªÉ l∆∞u tr·ªØ l√¢u d√†i
        // B·∫°n c·∫ßn m·ªôt Pin Virtual (v√≠ d·ª• V20) ƒë·ªÉ ch·ª©a chu·ªói t√™n n√†y n·∫øu mu·ªën ƒë·ªìng b·ªô
        const WORKER_URL = "https://blynk-token-proxy.tanthanhlttb123.workers.dev";
        const urlCloud = `${WORKER_URL}?action=update&pin=V0&value=${encodeURIComponent(JSON.stringify(customNames))}&device=cay`;
        
        fetch(urlCloud)
            .then(r => console.log("ƒê√£ ƒë·ªìng b·ªô t√™n l√™n Cloud"))
            .catch(e => console.log("Ch∆∞a ƒë·ªìng b·ªô ƒë∆∞·ª£c l√™n Cloud, nh∆∞ng t√™n ƒë√£ l∆∞u t·∫°m ·ªü m√°y"));

        // B∆Ø·ªöC 3: L·ªánh n√†y CH·ªà CH·∫†Y khi b·∫°n d√πng Web N·ªôi B·ªô (Local)
        // N·∫øu ƒëang d√πng Web Git, l·ªánh n√†y s·∫Ω b·ªã l·ªói ƒë·ªè (CORS) - b·∫°n c√≥ th·ªÉ l·ªù n√≥ ƒëi
       if (window.location.protocol !== 'file:') {
    fetch(`/set_name?pin=${p}&name=${encodeURIComponent(newName)}`)
        .then(r => console.log("ƒê√£ g·ª≠i l·ªánh ƒë·ªïi t√™n t·ªõi ESP32"))
        .catch(e => console.log("Kh√¥ng t√¨m th·∫•y ESP32 n·ªôi b·ªô"));
} else {
    console.log("ƒêang ch·∫°y file offline, b·ªè qua l·ªánh g·ª≠i t·ªõi ESP32 ƒë·ªÉ tr√°nh l·ªói ƒë·ªè.");
}
    }
}

*/
let isUpdating = false; // Bi·∫øn ch·∫∑n g·ª≠i tr√πng l·∫∑p

function editName(p) {
    if (isUpdating) return; // N·∫øu ƒëang g·ª≠i th√¨ kh√¥ng cho nh·∫•n ti·∫øp
    
    let oldName = (customNames[p] || p);
    let newName = prompt("T√™n m·ªõi cho " + p + ":", oldName);
    
    if (newName && newName !== oldName) {
        isUpdating = true;
        
        // 1. C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c (Offline tr∆∞·ªõc)
        customNames[p] = newName;
        localStorage.setItem('last_config', JSON.stringify(customNames));
        renderUI();

        // 2. G·ª≠i Cloud (Ch·ªâ g·ª≠i 1 l·∫ßn)
        const WORKER_URL = "https://blynk-token-proxy.tanthanhlttb123.workers.dev";
        const urlCloud = `${WORKER_URL}?action=update&pin=V0&value=${encodeURIComponent(JSON.stringify(customNames))}&device=cay`;
        
        fetch(urlCloud)
            .then(() => {
                console.log("ƒê√£ ƒë·ªìng b·ªô t√™n l√™n Cloud cho: " + p);
                isUpdating = false;
            })
            .catch(() => isUpdating = false);

        // 3. Ch·∫∑n l·ªói ƒë·ªè khi ch·∫°y file Offline
        if (window.location.protocol !== 'file:') {
            fetch(`/set_name?pin=${p}&name=${encodeURIComponent(newName)}`).catch(()=>{});
        } else {
            console.log("ƒêang ch·∫°y file offline, b·ªè qua l·ªánh n·ªôi b·ªô ƒë·ªÉ tr√°nh l·ªói ƒë·ªè.");
        }
    }
}
function phatWifiConfig() {
    let code = prompt("M√É X√ÅC TH·ª∞C:");
    if (!code) return;
    fetch('/phat_wifi_ap?auth_code=' + encodeURIComponent(code))
    .then(r => r.text()).then(txt => alert(txt)).catch(() => alert("ƒêang chuy·ªÉn ch·∫ø ƒë·ªô..."));
}
////22-1-2026 0H:48M
</script>

</body>
</html>
