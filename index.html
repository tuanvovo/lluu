<!DOCTYPE html>
<html>
<head>
  <title>Điều khiển ESP8266 qua MQTT</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    button {
      width: 100px;
      height: 50px;
      font-size: 18px;
      border-radius: 10px;
      background-color: #4CAF50;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #3e8e41;
    }
  </style>
</head>
<body>
  <h1>Điều khiển ESP8266 qua MQTT</h1>
  <button onclick="sendCommand('ON')">Bật</button>
  <button onclick="sendCommand('OFF')">Tắt</button>
  <div id="status"></div>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

<script>
    // Cấu hình chuẩn WSS cho Web Client
    var mqttBroker = "broker.hivemq.com"; 
    var mqttPort = 8884; 
    
    // Topic 1: GỬI LỆNH XUỐNG ESP8266
    var topicCommand = "tanthanhlttb123/control"; 
    // Topic 2: NHẬN PHẢN HỒI (ACK) TỪ ESP8266
    var topicStatus = "tanthanhlttb123/status"; 
    
    var client = new Paho.MQTT.Client(mqttBroker, mqttPort, "web-client-" + parseInt(Math.random() * 1000)); 

    // Các hàm xử lý sự kiện
    client.onConnectionLost = function(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("Mất kết nối:" + responseObject.errorMessage);
        }
        document.getElementById("status").innerHTML = "Trạng thái: ĐÃ NGẮT KẾT NỐI";
    }

    client.onMessageArrived = function(message) {
        // CHỈ XỬ LÝ TIN NHẮN TỪ TOPIC PHẢN HỒI (STATUS)
        if (message.destinationName === topicStatus) {
            var payload = message.payloadString;
            console.log("ACK nhận được: " + payload);
            
            if (payload === "OK") {
                document.getElementById("status").innerHTML = "Lệnh đã thực hiện: ✅ **THÀNH CÔNG**";
            } else if (payload === "FAIL") {
                document.getElementById("status").innerHTML = "Lệnh đã thực hiện: ❌ **THẤT BẠI**";
            } else {
                document.getElementById("status").innerHTML = "Trạng thái ESP8266: " + payload;
            }
        }
    }

    // Kết nối
    client.connect({
      onSuccess: function() {
        console.log("Connected to MQTT broker");
        // Đăng ký Topic Status với QoS 1 để nhận phản hồi từ ESP8266
        client.subscribe(topicStatus, { qos: 1 }); 
        document.getElementById("status").innerHTML = "Trạng thái: ĐANG KẾT NỐI";
      },
      useSSL: true, // Bắt buộc cho cổng 8884
      // Thêm thông tin đăng nhập nếu Broker yêu cầu (HiveMQ thì không)
    });

    // Hàm Gửi Lệnh (Gửi đến topicCommand)
    function sendCommand(command) {
        if (!client.isConnected()) {
             document.getElementById("status").innerHTML = "Trạng thái: CHƯA KẾT NỐI";
             return;
        }
        var message = new Paho.MQTT.Message(command);
        message.destinationName = topicCommand;
        // Gửi tin nhắn với QoS 1 (ACK)
        client.send(message, { qos: 1 });
        document.getElementById("status").innerHTML = "Đang gửi lệnh " + command + "...";
    }
</script>