<!DOCTYPE html>
<html lang="vi">
<head>
    <script>
        // (ƒê·∫£m b·∫£o ƒë√£ nh√∫ng th∆∞ vi·ªán Firebase n·∫øu b·∫°n d√πng n√≥)
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            // *** ƒê√É S·ª¨A: login.html -> index.html ***
            window.location.replace('index.html');
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêi·ªÅu khi·ªÉn ƒë√®n</title>
    <style>
    /* ======= KHUNG MOBILE GI·ªêNG HOME ======= */
.mobile-container {
    width: 100%;
    max-width: 390px;
    margin: 0 auto;
    background: linear-gradient(180deg, #ecebf0, #dcecff);
    min-height: 100vh;
    padding: 12px;
}

.img {
    background-size: cover; /* ph·ªß ƒë·ªÅu, kh√¥ng m√©o */
    background-position: center; /* canh gi·ªØa */
    background-repeat: no-repeat; /* kh√¥ng l·∫∑p */
}

body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
}

/* HEADER */
.header {
    width: 100%;
    display: flex;
    align-items: center;
    padding: 10px;
    margin-bottom: 15px;
}

.back-btn {
    width: 38px;
    height: 38px;
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.55);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-right: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18);
    font-size: 18px;
}

.disabled-banner {
    opacity: 0.5; /* M·ªù ƒëi */
    cursor: not-allowed !important; /* Bi·ªÉu t∆∞·ª£ng kh√¥ng cho ph√©p */
}

.header h2 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    color: #003366;
}

/* GRID */
.rooms-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 14px;
}

.room-card {
    background: rgba(255, 255, 255, 0.9); /* TRONG M·ªú ‚Üí ·∫£nh ƒë·∫πp h∆°n nhi·ªÅu */
    backdrop-filter: blur(5px); /* m·ªù n·ªÅn (glass UI) */
    border-radius: 0px;
    border: none;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
}

.room-card.is-on {
    /* N·ªÅn tr·∫Øng ho√†n to√†n */
    background: white;
    /* ƒê·ªï b√≥ng l·ªõn h∆°n v√† c√≥ m√†u xanh nh·∫π */
    box-shadow: 0 10px 30px rgba(0, 150, 255, 0.4), 0 0 15px rgba(0, 150, 255, 0.2);
    /* H∆°i ƒë·∫©y l√™n ph√≠a tr∆∞·ªõc */
    transform: translateY(-2px);
}

/* Th√™m hi·ªáu ·ª©ng khi th·∫ª ƒë∆∞·ª£c ch·∫°m/nh·∫•p v√†o */
.room-card:active {
    transform: translateY(2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.20);
}

/* ·∫¢NH CAO H∆†N */
.room-img {
    height: 120px; /* tƒÉng chi·ªÅu cao ‚Üí kh√¥ng c·∫Øt ·∫£nh */
    background-size: cover;
    background-position: center;
    border-bottom: none;
}

/* T√äN PH√íNG + N√öT CHUNG 1 H√ÄNG */
.room-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
}

.room-title {
    font-weight: 300;
    color: #003366;
    font-size: 15px;
}

/* N√öT DUY NH·∫§T */
.btn-toggle {
    padding: 6px 16px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: white;
    box-shadow: 0 3px 8px rgba(238, 238, 241, 0.329);
}

/* Tr·∫°ng th√°i n√∫t */
.btn-onstate {
    background: #4CAF50;
} /* xanh */

.btn-offstate {
    background: #7a7aa7;
} /* x√°m ƒë·∫≠m */

/* BANNER D∆Ø·ªöI */
.bottom-banner2, .bottom-banner {
    margin-top: 28px;
    background: linear-gradient(90deg, #393a3b, #56CCF2);
    padding: 16px;
    color: white;
    border-radius: 0px;
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.22);
}

/* POPUP */
#scheduleModal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.55);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 999;
}

.modal-box {
    background: white;
    /* üî• S·ª¨A: TƒÉng max-width ƒë·ªÉ chi·∫øm g·∫ßn h·∫øt chi·ªÅu ngang c·ªßa mobile-container (390px) */
    width: 95%; /* 88% c≈© h∆°i b√© */
    max-width: 370px; /* 360px c≈© h∆°i b√© */
    border-radius: 12px; /* Th√™m border-radius cho modal-box */
    padding: 20px; /* Gi·∫£m padding m·ªôt ch√∫t ƒë·ªÉ g·ªçn h∆°n */
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
}

/* N√öT L∆ØU */
.btn-save {
    width: 100%;
    /* üî• S·ª¨A: Gi·∫£m padding chung ƒë·ªÉ n√∫t nh·ªè g·ªçn h∆°n */
    padding: 8px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    margin-bottom: 10px;
    cursor: pointer;
}

/* N√öT X√ìA */
.btn-delete {
    width: 100%;
    /* üî• S·ª¨A: Gi·∫£m padding ƒë·ªÉ ƒë·ªìng nh·∫•t v·ªõi btn-save */
    padding: 8px;
    background: #E53935;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    cursor: pointer;
}
        /* [Xem ph·∫ßn 2. Phong c√°ch CSS] */
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="header">
            <div class="back-btn" onclick="history.back()">‚¨Ö</div>
            <h2>ƒêi·ªÅu khi·ªÉn ƒê√®n</h2>
        </div>

        <div class="rooms-grid">
            <div class="room-card" data-room="Ph√≤ng kh√°ch" data-room-id="1" data-on="img/phongkhach_on.jpg" data-off="img/phongkhach_off.jpg">
                <div class="room-img"></div>
                <div class="room-footer">
                    <div class="room-title">Ph√≤ng kh√°ch</div>
                    <button class="btn-toggle btn-offstate">OFF</button>
                </div>
            </div>

            <div class="room-card" data-room="Ph√≤ng b·∫øp" data-room-id="2" data-on="img/phongbep_on.jpg" data-off="img/phongbep_off.jpg">
                <div class="room-img"></div>
                <div class="room-footer">
                    <div class="room-title">Ph√≤ng b·∫øp</div>
                    <button class="btn-toggle btn-offstate">OFF</button>
                </div>
            </div>

            <div class="room-card" data-room="Ph√≤ng ƒë·ªçc" data-room-id="3" data-on="img/phongdoc_on.jpg" data-off="img/phongdoc_off.jpg">
                <div class="room-img"></div>
                <div class="room-footer">
                    <div class="room-title">Ph√≤ng ƒë·ªçc</div>
                    <button class="btn-toggle btn-offstate">OFF</button>
                </div>
            </div>

            <div class="room-card" data-room="Ph√≤ng ng·ªß" data-room-id="4" data-on="img/phongngu_on.jpg" data-off="img/phongngu_off.jpg">
                <div class="room-img"></div>
                <div class="room-footer">
                    <div class="room-title">Ph√≤ng ng·ªß</div>
                    <button class="btn-toggle btn-offstate">OFF</button>
                </div>
            </div>

            <div class="room-card" data-room="Ph√≤ng t·∫Øm" data-room-id="5" data-on="img/phongtam_on.jpg" data-off="img/phongtam_off.jpg">
                <div class="room-img"></div>
                <div class="room-footer">
                    <div class="room-title">Ph√≤ng t·∫Øm</div>
                    <button class="btn-toggle btn-offstate">OFF</button>
                </div>
            </div>

            <div class="room-card" data-room="ƒê√®n s√¢n nh√†" data-room-id="6" data-on="img/denvuong_on.jpg" data-off="img/denvuong_off.jpg">
                <div class="room-img"></div>
                <div class="room-footer">
                    <div class="room-title">ƒê√®n s√¢n nh√†</div>
                    <button class="btn-toggle btn-offstate">OFF</button>
                </div>
            </div>
        </div>
        
        <div class="bottom-banner2" onclick="getAllStatus()">Xem tr·∫°ng th√°i c√°c ƒê√®n</div>
        <div id="statusMessageBox" style="text-align:center; margin-top:10px; font-size:14px; color:#333;"></div>
        
        <div class="bottom-banner" id="openSchedule">H·∫πn gi·ªù cho c√°c ph√≤ng</div>
        
        <div class="bottom-banner password-update-header" onclick="togglePasswordForm()">
            C·∫≠p nh·∫≠t T√™n/M·∫≠t kh·∫©u
        </div>
        <div id="passwordUpdateForm" style="display:none; margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.85); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <label for="newUsername" style="font-weight: 600; color: #003366; display: block; margin-bottom: 5px;">Username/T√™n ƒëƒÉng nh·∫≠p m·ªõi:</label>
            <input type="text" id="newUsername" placeholder="Nh·∫≠p t√™n m·ªõi (t·ªëi ƒëa 32 k√Ω t·ª±)" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px;">
            <label for="newPassword" style="font-weight: 600; color: #003366; display: block; margin-bottom: 5px;">Password/M·∫≠t kh·∫©u m·ªõi:</label>
            <input type="password" id="newPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (t·ªëi ƒëa 32 k√Ω t·ª±)" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px;">
            <button id="sendNewCredentials" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
                G·ª≠i C·∫≠p nh·∫≠t M·∫≠t kh·∫©u
            </button>
            <div id="passwordStatusMessage" style="text-align: center; margin-top: 10px; font-size: 14px; color: #333;"></div>
        </div>
        
        <div style="height: 30px;"></div>
    </div>

    <div id="scheduleModal">
        <div class="modal-box">
            <h3>H·∫πn gi·ªù cho ph√≤ng</h3>
            <label>Ch·ªçn ph√≤ng:</label>
            <select id="roomSelect" style="width:100%; padding:10px; border-radius:12px;">
                <option>Ph√≤ng kh√°ch</option>
                <option>Ph√≤ng b·∫øp</option>
                <option>Ph√≤ng ƒë·ªçc</option>
                <option>Ph√≤ng ng·ªß</option>
                <option>Ph√≤ng t·∫Øm</option>
                <option>ƒê√®n s√¢n nh√†</option>
            </select>
            <br><br>
            <label>Gi·ªù b·∫≠t:</label>
            <input type="time" id="timeOn" style="width:100%; padding:10px; border-radius:12px;">
            <br><br>
            <label>Gi·ªù t·∫Øt:</label>
            <input type="time" id="timeOff" style="width:100%; padding:10px; border-radius:12px;">
            <br><br>
            <button class="btn-save" onclick="saveSchedule()">L∆∞u h·∫πn gi·ªù</button>
            <button class="btn-save" onclick="viewSchedule()">Xem h·∫πn gi·ªù</button>
            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 10px; margin-bottom: 10px;">
                <button class="btn-delete" style="flex: 1;" onclick="deleteSingleSchedule()">
                    X√≥a (1 Ph√≤ng)
                </button>
                <button class="btn-delete" style="flex: 1; background: #f44336;" onclick="deleteAllSchedules()">
                    X√≥a T·∫§T C·∫¢
                </button>
            </div>
            <button id="sendAllSchedulesInModal" style="width: 100%; padding: 8px; background: #007bff; color: white; border: none; border-radius: 12px; font-size: 16px; margin-bottom: 10px; cursor: pointer;">
                G·ª≠i T·∫§T C·∫¢ L·ªäCH
            </button>
            <button class="close-btn" onclick="closeModal()" style="width: 100%; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer;">
                ƒê√≥ng
            </button>
        </div>
    </div>

    <div id="viewModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); justify-content:center; align-items:center; z-index:999;">
        <div style="background:white; width:88%; max-width:360px; padding:22px; border-radius: 12px;">
            <h3>Danh s√°ch h·∫πn gi·ªù</h3>
            <ul id="viewList"></ul>
            <button class="btn-save" onclick="closeView()">ƒê√≥ng</button>
        </div>
    </div>
    
    <script>
       // =========================================================================================
// KH·ªêI CODE JAVASCRIPT ƒê∆Ø·ª¢C CH·ªàNH S·ª¨A V√Ä B·ªî SUNG
// =========================================================================================

// C√ÅC H·∫∞NG S·ªê
const LIGHT_PINS = {
    "Ph√≤ng kh√°ch": "V3",
    "Ph√≤ng b·∫øp": "V4",
    "Ph√≤ng ƒë·ªçc": "V5",
    "Ph√≤ng ng·ªß": "V6",
    "Ph√≤ng t·∫Øm": "V7",
    "ƒê√®n s√¢n nh√†": "V8"
};

const ROOM_IDS_MAP = {
    "Ph√≤ng kh√°ch": 1,
    "Ph√≤ng b·∫øp": 2,
    "Ph√≤ng ƒë·ªçc": 3,
    "Ph√≤ng ng·ªß": 4,
    "Ph√≤ng t·∫Øm": 5,
    "ƒê√®n s√¢n nh√†": 6
};

// BI·∫æN TR·∫†NG TH√ÅI
// tr·∫°ng th√°i t·ª´ng ƒë√®n (0 = OFF, 1 = ON)
let lightStates = {
    "V3": 0, "V4": 0, "V5": 0, "V6": 0, "V7": 0, "V8": 0
};
// üî• BI·∫æN TO√ÄN C·ª§C M·ªöI: D√πng ƒë·ªÉ l∆∞u tr·ªØ l·ªãch h·∫πn gi·ªù
let allSchedules = {};
// URL Worker c·ªßa b·∫°n
const WORKER_URL = "https://blynk-token-proxy.tanthanhlttb123.workers.dev";
// === ƒê·ªåC C·ªú QUY·ªÄN T·ª™ LOCAL STORAGE ===
const isAdmin = localStorage.getItem('isAdmin') === 'true';
const isUserAllowedToWrite = isAdmin; // Ch·ªâ Admin ƒë∆∞·ª£c GHI
// =======================================

// --- H√ÄM G·ª¨I L·ªÜNH T·ªöI WORKER (Blynk Proxy) ---
async function sendCommand(pin, value) {
    const responseBox = document.getElementById("responseBox");
    if (!isUserAllowedToWrite && pin !== "V10") { // Cho ph√©p g·ª≠i V10 (CRED) ƒë·ªÉ demo
        return; // CH·∫∂N L·ªÜNH G·ª¨I ƒêI
    }
    try {
        // N·∫øu value l√† object ‚Üí stringify (an to√†n)
        const raw = (typeof value === "string") ? value : JSON.stringify(value);
        // Encode ƒë·ªÉ kh√¥ng l√†m v·ª° URL query
        const encoded = encodeURIComponent(raw);

        // N·∫øu qu√° d√†i (> 1800 k√Ω t·ª±) th√¨ d√πng POST (tr√°nh l·ªói URL length)
        if (encoded.length > 1800) {
            const res = await fetch(WORKER_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                // Worker ph·∫£i x·ª≠ l√Ω body d·∫°ng urlencoded (action, pin, value, device)
                body: `action=update&pin=${encodeURIComponent(pin)}&value=${encoded}&device=cay`
            });
            if (res.ok) console.log(`‚úÖ [POST] ${pin} g·ª≠i th√†nh c√¥ng`);
            else console.error(`‚ùå [POST] l·ªói ${pin}: ${res.status}`);
            return;
        }

        // V·ªõi chu·ªói ng·∫Øn, d√πng GET truy·ªÅn param ƒë√£ encode
        const res = await fetch(`${WORKER_URL}?action=update&pin=${encodeURIComponent(pin)}&value=${encoded}&device=cay`);
        if (res.ok) {
            console.log(`‚úÖ [GET] L·ªánh ${pin} g·ª≠i th√†nh c√¥ng`);
        } else {
            console.error(`‚ùå [GET] L·ªói g·ª≠i ${pin}: ${res.status}`);
        }
    } catch (err) {
        console.error("‚ö†Ô∏è Kh√¥ng g·ª≠i ƒë∆∞·ª£c l·ªánh", err);
    }
}

// --- H√ÄM ƒêI·ªÄU KHI·ªÇN B·∫¨T/T·∫ÆT ƒê√àN ---
function toggleLight(pin, card) {
    const current = lightStates[pin] || 0;
    const nextState = current === 1 ? 0 : 1;

    // c·∫≠p nh·∫≠t UI (G·ªçi h√†m chung ƒë·ªÉ n√≥ √°p d·ª•ng c·∫£ class is-on)
    updateLightUI(pin, nextState, card);

    // l∆∞u tr·∫°ng th√°i
    lightStates[pin] = nextState;

    // g·ª≠i l·ªánh Worker
    sendCommand(pin, nextState);
}

// C·∫≠p nh·∫≠t giao di·ªán (UI) cho t·ª´ng ƒë√®n
function updateLightUI(pin, state, card) {
    const btn = card.querySelector(".btn-toggle");
    const img = card.querySelector(".room-img");

    // L∆∞u tr·∫°ng th√°i m·ªõi
    lightStates[pin] = state;
    card.classList.toggle("is-on", state === 1); // C·∫≠p nh·∫≠t class is-on

    if (btn) {
        btn.innerText = state === 1 ? "ON" : "OFF";
        btn.classList.toggle("btn-onstate", state === 1);
        btn.classList.toggle("btn-offstate", state === 0);
    }

    if (img) {
        // L·∫•y ƒë∆∞·ªùng d·∫´n ·∫£nh d·ª±a tr√™n tr·∫°ng th√°i
        const imgUrl = state === 1 ? card.dataset.on : card.dataset.off;
        img.style.backgroundImage = `url('${imgUrl}')`;
    }
}

// --- H√ÄM ƒê·ªåC TR·∫†NG TH√ÅI T·ª™ WORKER (get) ---
async function getStatus(pin, card) {
    try {
        const res = await fetch(`${WORKER_URL}?action=get&pin=${pin}&device=cay`);
        if (res.ok) {
            const rawValue = await res.text();
            // L·ªçc ch·ªâ l·∫•y s·ªë '1' ho·∫∑c '0'
            const cleanValue = rawValue.replace(/[^0-9]/g, '');
            let state = 0;
            // X·ª≠ l√Ω gi√° tr·ªã: Ch·ªâ ch·∫•p nh·∫≠n 1 ho·∫∑c 0
            if (cleanValue === '1' || cleanValue === '0') {
                state = parseInt(cleanValue, 10);
            } else {
                console.warn(`[ƒê√àN] Pin ${pin} tr·∫£ v·ªÅ gi√° tr·ªã kh√¥ng h·ª£p l·ªá: ${rawValue}`);
                // B√°o l·ªói nh∆∞ng kh√¥ng d·ª´ng c√°c pin kh√°c
                return { success: false, error: 'Invalid Value' };
            }
            // üî• C·∫¨P NH·∫¨T GIAO DI·ªÜN NGAY L·∫¨P T·ª®C CHO ƒê√àN N√ÄY
            updateLightUI(pin, state, card);
            return { success: true, state: state }; // Tr·∫£ v·ªÅ th√†nh c√¥ng
        } else {
            console.error(`‚ùå L·ªói ƒë·ªçc ${pin}: M√£ tr·∫°ng th√°i ${res.status}`);
            return { success: false, error: res.status }; // Tr·∫£ v·ªÅ th·∫•t b·∫°i
        }
    } catch (error) {
        // L·ªói k·∫øt n·ªëi, timeout...
        console.error(`‚ö†Ô∏è L·ªói k·∫øt n·ªëi ho·∫∑c timeout cho ${pin}`, error);
        return { success: false, error: 'Connection Error' };
    }
}

// ƒê·ªçc tr·∫°ng th√°i t·∫•t c·∫£ ƒë√®n
async function getAllStatus() {
    const messageBox = document.getElementById("statusMessageBox");
    messageBox.textContent = "ƒêang ƒë·ªçc tr·∫°ng th√°i t·∫•t c·∫£ ƒë√®n...";
    messageBox.style.color = "gray";
    const allCards = document.querySelectorAll(".room-card");
    let successfulReads = 0;

    // Ch·∫°y c√°c l·ªánh ƒë·ªçc tr·∫°ng th√°i ƒë·ªìng th·ªùi (Promise.all)
    const statusPromises = Array.from(allCards).map(async (card) => {
        const roomName = card.dataset.room;
        const pin = LIGHT_PINS[roomName];
        if (pin) {
            const result = await getStatus(pin, card);
            // Ch·ªâ ƒë·∫øm khi th√†nh c√¥ng (success: true)
            if (result.success) {
                successfulReads++;
            }
        }
    });

    // Ch·ªù t·∫•t c·∫£ Promise ho√†n th√†nh
    await Promise.all(statusPromises);

    // Hi·ªÉn th·ªã k·∫øt qu·∫£ t·ªïng h·ª£p
    if (successfulReads === allCards.length) {
        messageBox.textContent = `‚úÖ ƒê√£ ƒë·ªçc tr·∫°ng th√°i th√†nh c√¥ng cho t·∫•t c·∫£ ${successfulReads}/${allCards.length} ƒë√®n.`;
        messageBox.style.color = "green";
    } else if (successfulReads > 0) {
        messageBox.textContent = `‚ö†Ô∏è Ho√†n th√†nh ${successfulReads}/${allCards.length} ƒë√®n. Vui l√≤ng th·ª≠ l·∫°i n·∫øu mu·ªën ƒë·ªçc ƒë·ªß ${allCards.length}/${allCards.length}.`;
        messageBox.style.color = "#FF9800"; // M√†u cam ƒë·∫≠m
    } else {
        messageBox.textContent = "‚ùå L·ªói k·∫øt n·ªëi. Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c tr·∫°ng th√°i ƒë√®n n√†o.";
        messageBox.style.color = "red";
    }
}


// --- H√ÄM C·∫¨P NH·∫¨T T√äN/M·∫¨T KH·∫®U (G·ª≠i V10 - CRED) ---
function togglePasswordForm() {
    const form = document.getElementById('passwordUpdateForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
    document.getElementById('passwordStatusMessage').textContent = '';
}

async function sendNewCredentials() {
    if (!isUserAllowedToWrite) {
        alert("‚ùå B·∫°n l√† Kh√°ch Demo. Kh√¥ng th·ªÉ C·∫≠p nh·∫≠t th√¥ng tin x√°c th·ª±c.");
        return;
    }
    const usernameInput = document.getElementById('newUsername');
    const passwordInput = document.getElementById('newPassword');
    const messageBox = document.getElementById('passwordStatusMessage');
    const newUsername = usernameInput.value.trim();
    const newPassword = passwordInput.value.trim();

    if (newUsername.length < 4 || newPassword.length < 6) {
        messageBox.textContent = "‚ùå T√™n ƒëƒÉng nh·∫≠p (min 4) ho·∫∑c M·∫≠t kh·∫©u (min 6) qu√° ng·∫Øn.";
        messageBox.style.color = "red";
        return;
    }

    if (!confirm(`X√°c nh·∫≠n c·∫≠p nh·∫≠t T√™n: "${newUsername}" v√† M·∫≠t kh·∫©u m·ªõi? (Thi·∫øt b·ªã s·∫Ω kh·ªüi ƒë·ªông l·∫°i)`)) {
        return;
    }

    // Chu·∫©n b·ªã d·ªØ li·ªáu JSON ƒë·ªÉ g·ª≠i
    const jsonPayload = { // <--- ƒê·ªïi t√™n bi·∫øn ƒë·ªÉ r√µ r√†ng h∆°n
        u: newUsername,
        p: newPassword
    };
    // 2. Chuy·ªÉn ƒë·ªëi t∆∞·ª£ng JSON th√†nh chu·ªói
    const jsonString = JSON.stringify(jsonPayload);
    // 3. TH√äM TI·ªÄN T·ªê ƒê·∫∂C BI·ªÜT "CRED:"
    const finalPayload = "CRED:" + jsonString; // V√≠ d·ª•: "CRED:{\"u\":\"new_user\",\"p\":\"new_pass\"}"

    // G·ª≠i chu·ªói JSON n√†y l√™n Virtual Pin V10
    const VIRTUAL_PIN_CREDENTIALS = "V10";
    messageBox.textContent = "ƒêang g·ª≠i th√¥ng tin m·ªõi ƒë·∫øn ESP32...";
    messageBox.style.color = "gray";
    try {
        await sendCommand(VIRTUAL_PIN_CREDENTIALS, finalPayload);
        messageBox.textContent = `‚úÖ ƒê√£ g·ª≠i T√™n/M·∫≠t kh·∫©u m·ªõi. Thi·∫øt b·ªã ƒëang kh·ªüi ƒë·ªông l·∫°i ƒë·ªÉ √°p d·ª•ng.`;
        messageBox.style.color = "green";
        // X√≥a tr∆∞·ªùng sau khi g·ª≠i th√†nh c√¥ng
        usernameInput.value = '';
        passwordInput.value = '';
    } catch (error) {
        messageBox.textContent = `‚ùå L·ªói g·ª≠i l·ªánh: ${error.message}`;
        messageBox.style.color = "red";
    }
}


// --- LOGIC H·∫∏N GI·ªú (L∆∞u v√†o localStorage ƒë·ªÉ kh√¥ng b·ªã m·∫•t khi chuy·ªÉn trang) ---

// T·∫£i l·ªãch ƒë√£ l∆∞u khi trang v·ª´a t·∫£i
function loadSchedules() {
    try {
        const stored = localStorage.getItem('savedSchedules');
        allSchedules = stored ? JSON.parse(stored) : {};
        // C·∫≠p nh·∫≠t l·∫°i thu·ªôc t√≠nh data-timer c·ªßa c√°c th·∫ª ph√≤ng
        document.querySelectorAll(".room-card").forEach(card => {
            const roomName = card.dataset.room;
            if (allSchedules[roomName]) {
                card.dataset.timer = allSchedules[roomName];
            } else {
                card.dataset.timer = "Ch∆∞a ƒë·∫∑t";
            }
        });
        console.log("‚úÖ ƒê√£ t·∫£i l·ªãch h·∫πn t·ª´ localStorage.");
    } catch (e) {
        console.error("L·ªói ƒë·ªçc localStorage", e);
        allSchedules = {};
    }
}

// L∆∞u l·ªãch v√†o localStorage
function saveSchedulesToLocal() {
    localStorage.setItem('savedSchedules', JSON.stringify(allSchedules));
}

// H√†m L∆ØU H·∫∏N GI·ªú (Gi·∫£i quy·∫øt V·∫•n ƒë·ªÅ 1: L∆∞u v√†o localStorage)
async function saveSchedule() {
    const room = document.getElementById("roomSelect").value;
    const timeOn = document.getElementById("timeOn").value;
    const timeOff = document.getElementById("timeOff").value;

    if (!timeOn || !timeOff) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß gi·ªù B·∫≠t v√† T·∫Øt!");

    // 1. G·ª≠i l·ªánh cho ESP qua Blynk (V√≠ d·ª• pin V10 t√πy b·∫°n c·∫•u h√¨nh)
    // sendCommand("V10", `${room}|${timeOn}|${timeOff}`); 

    // 2. G·ª¨I L·ªäCH L√äN CLOUDFLARE ƒê·ªÇ B√ÅO TELEGRAM
    try {
        const res = await fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: "SAVE_LICH_DEN",
                phong: room,
                bat: timeOn,
                tat: timeOff
            })
        });
        
        if(res.ok) {
            alert(`‚úÖ ƒê√£ l∆∞u l·ªãch ${room}. Telegram s·∫Ω b√°o khi t·ªõi gi·ªù!`);
            closeModal();
        }
    } catch (e) {
        alert("‚ùå L·ªói k·∫øt n·ªëi Cloudflare");
    }
}

// H√†m X√ìA M·ªòT L·ªäCH
function deleteSingleSchedule() {
    if (!isUserAllowedToWrite) {
        alert("‚ùå B·∫°n l√† Kh√°ch Demo. Kh√¥ng th·ªÉ X√≥a L·ªãch Tr√¨nh T·ª± ƒê·ªông.");
        return;
    }
    const room = document.getElementById('roomSelect').value;
    const roomID = ROOM_IDS_MAP[room];

    if (!roomID) {
        alert("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ID ph√≤ng. Ki·ªÉm tra l·∫°i t√™n ph√≤ng trong ROOM_IDS_MAP.");
        return;
    }

    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·∫πn gi·ªù c·ªßa ${room}?`)) {
        return;
    }

    // 1. X√≥a local
    delete allSchedules[room];
    saveSchedulesToLocal();

    // 2. C·∫≠p nh·∫≠t UI
    const card = document.querySelector(`[data-room="${room}"]`);
    if(card) card.dataset.timer = "Ch∆∞a ƒë·∫∑t";

    // 3. G·ª≠i l·ªánh DELETE v·ªÅ ESP32 (DEL:roomID)
    let cmd = `DEL:${roomID}`;
    console.log("SEND CMD (X√≥a 1 l·ªãch) =", JSON.stringify(cmd));
    sendCommand("V10", cmd);
    
    alert(`ƒê√£ x√≥a l·ªãch ph√≤ng: ${room}. Vui l√≤ng b·∫•m 'G·ª≠i T·∫§T C·∫¢ L·ªäCH' n·∫øu mu·ªën c·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c ph√≤ng c√≤n l·∫°i.`);
}

// H√†m X√ìA T·∫§T C·∫¢ L·ªäCH
function deleteAllSchedules() {
    if (!isUserAllowedToWrite) {
        alert("‚ùå B·∫°n l√† Kh√°ch Demo. Kh√¥ng th·ªÉ X√≥a T·∫§T C·∫¢ L·ªãch Tr√¨nh T·ª± ƒê·ªông.");
        return;
    }

    if (!confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA T·∫§T C·∫¢ l·ªãch h·∫πn gi·ªù cho m·ªçi ph√≤ng?")) {
        return;
    }

    // 1. X√≥a b·ªô nh·ªõ c·ª•c b·ªô
    allSchedules = {};
    saveSchedulesToLocal();

    // 2. C·∫≠p nh·∫≠t UI (xo√° data-timer)
    document.querySelectorAll(".room-card").forEach(card => {
        card.dataset.timer = "Ch∆∞a ƒë·∫∑t";
    });

    // 3. G·ª≠i chu·ªói V10 r·ªóng l√™n thi·∫øt b·ªã (X√≥a t·∫•t c·∫£ tr√™n thi·∫øt b·ªã)
    sendCommand("V10", "DELETE_ALL"); // G·ª≠i chu·ªói ƒë·∫∑c bi·ªát ƒë·ªÉ x√≥a h·∫øt l·ªãch c≈© tr√™n thi·∫øt b·ªã

    alert("‚úÖ ƒê√£ X√ìA T·∫§T C·∫¢ l·ªãch h·∫πn th√†nh c√¥ng (tr√™n tr√¨nh duy·ªát v√† ƒë√£ g·ª≠i l·ªánh x√≥a ƒë·∫øn thi·∫øt b·ªã).");
    closeModal();
}

// H√†m G·ª¨I T·∫§T C·∫¢ L·ªäCH (G·ª≠i chu·ªói t·ªïng h·ª£p V10)
function sendAllSchedulesFromModal() {
    if (!isUserAllowedToWrite) {
        console.warn("‚ùå B·∫°n l√† Kh√°ch Demo. Kh√¥ng th·ªÉ G·ª≠i L·ªãch Tr√¨nh T·ª± ƒê·ªông.");
        return false;
    }
    let result = "";
    let count = 0;

    // Duy·ªát qua t·∫•t c·∫£ c√°c ph√≤ng
    document.querySelectorAll(".room-card").forEach(card => {
        const roomName = card.dataset.room;
        const scheduleString = allSchedules[roomName]; // L·∫•y t·ª´ bi·∫øn ƒë√£ t·∫£i
        const id = card.dataset.roomId; // L·∫•y ID ph√≤ng (1-6)

        if (scheduleString && id) {
            // scheduleString c√≥ d·∫°ng "HH:mm ‚Üí HH:mm"
            const [onTime, offTime] = scheduleString.split("‚Üí").map(t => t.trim());
            // ƒê·ªãnh d·∫°ng chu·ªói V10: id:1 HH:mm true HH:mm false,
            result += `id:${id} ${onTime} true ${offTime} false,`;
            count++;
        }
    });

    if (result.length > 0) {
        const finalString = result.slice(0, -1); // Lo·∫°i b·ªè d·∫•u ph·∫©y cu·ªëi c√πng
        // G·ª≠i chu·ªói V10 ƒë√£ t·ªïng h·ª£p
        sendCommand("V10", finalString);
        console.log("Chu·ªói V10 g·ª≠i:", finalString);
        return true;
    } else {
        // G·ª≠i l·ªánh x√≥a t·∫•t c·∫£ n·∫øu kh√¥ng c√≥ l·ªãch n√†o ƒë∆∞·ª£c l∆∞u
        sendCommand("V10", "DELETE_ALL");
        return false;
    }
}

// H√†m xem l·ªãch h·∫πn
function viewSchedule() {
    const list = document.getElementById("viewList");
    list.innerHTML = "";
    document.querySelectorAll(".room-card").forEach(room => {
        const li = document.createElement("li");
        li.style.margin = "6px 0";
        li.textContent = `${room.dataset.room} : ${room.dataset.timer || "Ch∆∞a ƒë·∫∑t"}`;
        list.appendChild(li);
    });
    document.getElementById("viewModal").style.display = "flex";
}

// H√†m ƒë√≥ng Pop-up View
function closeView() {
    document.getElementById("viewModal").style.display = "none";
}

// H√†m ƒë√≥ng Pop-up Modal
function closeModal() {
    document.getElementById('scheduleModal').style.display = "none";
}

// H√†m t·∫£i tr∆∞·ªõc ·∫£nh
function preloadImages() {
    const allCards = document.querySelectorAll(".room-card");
    allCards.forEach(card => {
        const imgOn = new Image();
        imgOn.src = card.dataset.on;
        const imgOff = new Image();
        imgOff.src = card.dataset.off;
    });
}


// --- G√ÅN S·ª∞ KI·ªÜN KHI DOM T·∫¢I XONG ---
document.addEventListener('DOMContentLoaded', () => {
    // üî• 1. T·∫£i l·ªãch ƒë√£ l∆∞u t·ª´ localStorage
    loadSchedules();

    // üî• V√î HI·ªÜU H√ìA N√öT XEM TR·∫†NG TH√ÅI (N·∫øu l√† Kh√°ch Demo)
    if (isAdmin === false) {
        const checkStatusBtn = document.querySelector(".bottom-banner2");
        checkStatusBtn.classList.add("disabled-banner");
        checkStatusBtn.onclick = () => {
            const messageBox = document.getElementById("statusMessageBox");
            messageBox.textContent = "‚ùå B·∫°n l√† Kh√°ch Demo. Kh√¥ng th·ªÉ ƒë·ªçc tr·∫°ng th√°i.";
            messageBox.style.color = "red";
        };
    } else {
         // N·∫øu l√† Admin, g√°n s·ª± ki·ªán xem tr·∫°ng th√°i b√¨nh th∆∞·ªùng
         document.querySelector(".bottom-banner2").onclick = getAllStatus;
    }
    
    // üî• 2. G√°n s·ª± ki·ªán M·ªü Pop-up cho n√∫t "H·∫πn gi·ªù cho c√°c ph√≤ng"
    const openBtn = document.getElementById('openSchedule');
    if (openBtn) {
        openBtn.onclick = () => {
            document.getElementById('scheduleModal').style.display = "flex";
        };
    }

    // üî• 3. G√°n s·ª± ki·ªán G·ª¨I V10 cho n√∫t "G·ª≠i T·∫§T C·∫¢ L·ªäCH" m·ªõi
    const sendInModalBtn = document.getElementById('sendAllSchedulesInModal');
    if (sendInModalBtn) {
        sendInModalBtn.onclick = () => {
            if (!isUserAllowedToWrite) {
                alert("‚ùå B·∫°n l√† Kh√°ch Demo. Kh√¥ng th·ªÉ G·ª≠i L·ªãch Tr√¨nh T·ª± ƒê·ªông.");
                return;
            }
            const sent = sendAllSchedulesFromModal();
            if (sent) {
                alert("‚úÖ ƒê√£ g·ª≠i T·∫§T C·∫¢ l·ªãch h·∫πn th√†nh c√¥ng!");
                closeModal();
            } else {
                alert("‚ö†Ô∏è Kh√¥ng c√≥ l·ªãch h·∫πn n√†o ƒë·ªÉ g·ª≠i. Vui l√≤ng L∆∞u tr∆∞·ªõc.");
            }
        };
    }

    // üî• 4. G√°n s·ª± ki·ªán cho n√∫t G·ª≠i Username/Password
    const sendCredBtn = document.getElementById('sendNewCredentials');
    if (sendCredBtn) {
        sendCredBtn.onclick = sendNewCredentials;
    }

    // üî• 5. Kh·ªüi t·∫°o ·∫£nh OFF + G√°n s·ª± ki·ªán n√∫t ON/OFF
    document.querySelectorAll(".room-card").forEach(card => {
        const btn = card.querySelector(".btn-toggle");
        const img = card.querySelector(".room-img");

        // ·∫£nh OFF m·∫∑c ƒë·ªãnh
        img.style.backgroundImage = `url('${card.dataset.off}')`;
        btn.dataset.state = "off";
        btn.classList.add("btn-offstate");

        // G√°n s·ª± ki·ªán b·∫≠t/t·∫Øt
        btn.onclick = () => {
            const roomName = card.dataset.room;
            const pin = LIGHT_PINS[roomName];
            if (!pin) return console.error("Kh√¥ng t√¨m th·∫•y pin cho", roomName);
            toggleLight(pin, card);
        };
    });

    // G·ªçi h√†m preload
    preloadImages();
});
    </script>
</body>
</html>
