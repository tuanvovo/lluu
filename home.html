<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>H·ªá Th·ªëng Th√¥ng Minh</title>
    <style>
        /* T√¨m v√† thay th·∫ø c√°c d√≤ng t∆∞∆°ng ·ª©ng trong :root v√† c√°c class btn */
:root { 
    --bg: #f0f2f5; 
    --primary: #1a73e8; 
    --on-active: #2ecc71;   /* Xanh ƒë·∫≠m khi B·∫¨T */
    --on-dim: #e8f5e9;      /* Xanh nh·∫°t khi ch∆∞a B·∫¨T */
    --off-active: #7f8c8d;  /* X√°m l√¥ng chu·ªôt ƒë·∫≠m khi T·∫ÆT */
    --off-dim: #f5f5f5;     /* X√°m l√¥ng chu·ªôt nh·∫°t khi ch∆∞a T·∫ÆT */
}
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .device-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; text-align: center; padding: 10px; display: flex; flex-direction: column; }
        .device-img { width: 100%; height: 100px; object-fit: cover; border-radius: 5px; cursor: pointer; background: #eee; transition: 0.3s; }
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .btn { border: none; padding: 8px; border-radius: 5px; cursor: pointer; flex: 1; font-weight: bold; font-size: 12px; }
        /* N√∫t B·∫¨T m·∫∑c ƒë·ªãnh */
.btn-on { background: var(--on-dim); color: var(--on-active); border: 1px solid var(--on-active); }
/* N√∫t T·∫ÆT m·∫∑c ƒë·ªãnh */
.btn-off { background: var(--off-dim); color: var(--off-active); border: 1px solid var(--off-active); }
      /* Khi ƒëang ·ªü tr·∫°ng th√°i B·∫¨T (Active) */
.active-on { background: var(--on-active) !important; color: white !important; }
/* Khi ƒëang ·ªü tr·∫°ng th√°i T·∫ÆT (Active) */
.active-off { background: var(--off-active) !important; color: white !important; }
       
       
        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
        .list-box { border: 1px solid #eee; padding: 10px; border-radius: 5px; margin-bottom: 10px; min-height: 40px; background: #fafafa; }
        .list-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; font-size: 13px; }
        .btn-del { color: red; cursor: pointer; font-weight: bold; padding: 0 10px; }
        .btn-save { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
   
         .device-img:active {
    transform: scale(0.95);
    opacity: 0.8;
}
   </style>
</head>
<body>

    <div class="card">
        <h3>ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã</h3>
        <div id="device_list" class="grid-container"></div>
    </div>

    <div class="card">
        <h3>L·ªãch T∆∞·ªõi Lan (V2)</h3>
        <div class="input-group">
            <input type="time" id="v2_t">
            <input type="number" id="v2_d" placeholder="Ph√∫t">
            <button onclick="addV2()" style="padding:0 15px;">+</button>
        </div>
        <div id="v2_list" class="list-box"></div>
        <button class="btn-save" style="background: var(--on)" onclick="saveV2(this)">G·ª¨I & L∆ØU L·ªäCH T∆Ø·ªöI</button>
    </div>

    <div class="card">
        <h3>L·∫≠p l·ªãch ƒê√®n (V10)</h3>
        <select id="v10_id"></select>
        <div class="input-group" style="margin-top:10px;">
            <input type="time" id="v10_on">
            <input type="time" id="v10_off">
            <button onclick="addV10()" style="padding:0 15px;">+</button>
        </div>
        <div id="v10_list" class="list-box"></div>
        <button class="btn-save" onclick="saveV10(this)">G·ª¨I & L∆ØU L·ªäCH ƒê√àN</button>
    </div>

    <button class="btn-save" style="background: #e67e22; margin-bottom: 30px;" onclick="phatWifiConfig()">üîÑ ƒê·ªîI M·∫†NG WIFI (PH√ÅT AP)</button>

<script>



const allPins = ["V1", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10"];
const v10Mapping = {"1":"V3", "2":"V4", "3":"V6", "4":"V5", "5":"V7", "6":"V8"};
const idLookup = {"V1":1,"V2":2,"V3":3,"V4":4,"V5":5,"V6":6,"V7":7,"V8":8,"V9":9,"V10":10};
let customNames = {};
let listV2 = [], listV10 = [];

// --- C·∫§U H√åNH TH√îNG MINH ---
const IP_ESP32 = "192.168.1.200"; 
const segment = "1"; // ƒê·ªãnh nghƒ©a s·ªë segment ƒë·ªÉ tr√°nh l·ªói fetch
const WORKER_URL = "https://blynk-token-proxy.tanthanhlttb123.workers.dev";
const DEVICE_NAME = "cay";

const isLocal = window.location.hostname.includes("192.168") || window.location.hostname === "localhost";
const basePrefix = isLocal ? `http://${IP_ESP32}` : WORKER_URL;



//---------------------------------------------------------------------
document.addEventListener("DOMContentLoaded", function() {
    let cachedNames = localStorage.getItem('last_config');
    let cachedV2 = localStorage.getItem('v2_list_cache');
    let cachedV10 = localStorage.getItem('v10_list_cache');

    if(cachedNames) customNames = JSON.parse(cachedNames);
    if(cachedV2) listV2 = JSON.parse(cachedV2);
    if(cachedV10) listV10 = JSON.parse(cachedV10);

    renderUI(); 

    if (isLocal) {
        fetch('/get_config?t=' + Date.now()).then(r => r.json()).then(data => {
            if(data && Object.keys(data).length > 0) {
                customNames = data;
                localStorage.setItem('last_config', JSON.stringify(data));
                renderUI();
            }
        }).catch(()=>{});
    }
    setInterval(updateStatusOnly, 3000);
});

// H√†m l·∫•y th√¥ng b√°o gi·ªçng n√≥i
setInterval(function() {
    if (!isLocal) return;
    fetch('/get_notify').then(r => r.text()).then(txt => {
        if (txt && txt.trim().length > 1) {
            let msg = new SpeechSynthesisUtterance(txt);
            msg.lang = 'vi-VN';
            window.speechSynthesis.speak(msg);
        }
    }).catch(e => {});
}, 1000);

function renderUI() {
    let h = "";
    allPins.forEach(p => {
        let savedImg = localStorage.getItem('img_' + p);
        let imgSrc = "";
        
        if (savedImg) {
            imgSrc = savedImg; // ∆Øu ti√™n ·∫£nh n√©t trong m√°y
        } else if (isLocal) {
            imgSrc = `/${p.toUpperCase()}.JPG?t=${Date.now()}`; // L·∫•y t·ª´ ESP32 n·∫øu ·ªü nh√†
        } else {
            imgSrc = "https://via.placeholder.com/150/cccccc/ffffff?text=" + p;
        }

        h += `<div class="device-card">
            <img src="${imgSrc}" id="img-tag-${p}"
            class="device-img" 
            onerror="this.src='https://via.placeholder.com/150/cccccc/ffffff?text=No+Image'"
            onclick="uploadImg('${p}')" >
            <span id="name-device-${p}" style="cursor:pointer; font-weight:bold; margin-top:5px; display:block;" onclick="editName('${p}')">
                ${customNames[p] || p} ‚úèÔ∏è
            </span>
            <div class="btn-group">
                <button id="on-${p}" class="btn btn-on" onclick="sendCmd('${p}',1)">B·∫¨T</button>
                <button id="off-${p}" class="btn btn-off" onclick="sendCmd('${p}',0)">T·∫ÆT</button>
            </div>
        </div>`;
    });
    document.getElementById('device_list').innerHTML = h;

    // Load options cho V10
    let opt = "";
    for (let id in v10Mapping) {
        opt += `<option value="${id}">${customNames[v10Mapping[id]] || ("ƒê√®n " + id)}</option>`;
    }
    let v10Select = document.getElementById('v10_id');
    if(v10Select) v10Select.innerHTML = opt;

    document.getElementById('v2_list').innerHTML = listV2.map((x, i) => 
        `<div class="list-item"><span><b>${x.t}</b> - T∆∞·ªõi ${x.d}p</span><span class="btn-del" onclick="removeV2(${i})">‚úñ</span></div>`
    ).join('') || '<div style="color:#ccc;text-align:center">Tr·ªëng</div>';

    document.getElementById('v10_list').innerHTML = listV10.map((x, i) => 
        `<div class="list-item"><span><b>${customNames[v10Mapping[x.id]] || 'ƒê√®n '+x.id}:</b> ${x.on} ‚ûî ${x.off}</span><span class="btn-del" onclick="removeV10(${i})">‚úñ</span></div>`
    ).join('') || '<div style="color:#ccc;text-align:center">Tr·ªëng</div>';
}

// --- H√ÄM CH·ªåN ·∫¢NH SI√äU N√âT ---
function uploadImg(pin) {
    let input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = e => {
        let file = e.target.files[0];
        if (!file) return;

        let reader = new FileReader();
        reader.onload = event => {
            let img = new Image();
            img.onload = () => {
                let canvas = document.createElement('canvas');
                let ctx = canvas.getContext('2d');

                // 1. L∆ØU B·∫¢N N√âT V√ÄO LOCALSTORAGE (D√πng cho Web Git)
                let MAX_WEB = 600; 
                let scaleWeb = MAX_WEB / img.width;
                canvas.width = MAX_WEB;
                canvas.height = img.height * scaleWeb;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                let highResData = canvas.toDataURL('image/jpeg', 0.8);
                try {
                    localStorage.setItem('img_' + pin, highResData);
                    document.getElementById('img-tag-' + pin).src = highResData;
                } catch(e) { console.log("B·ªô nh·ªõ ƒë·∫ßy, kh√¥ng th·ªÉ l∆∞u ·∫£nh n√©t"); }

                // 2. N√âN 20KB G·ª¨I ESP32 (Ch·ªâ g·ª≠i khi ·ªü nh√† - isLocal)
                if (isLocal) {
                    let MAX_ESP = 300;
                    let scaleESP = MAX_ESP / img.width;
                    canvas.width = MAX_ESP;
                    canvas.height = img.height * scaleESP;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob(blob => {
                        let formData = new FormData();
                        formData.append("image", blob, pin.toUpperCase() + ".JPG");
                        fetch('/upload', { method: 'POST', body: formData });
                    }, 'image/jpeg', 0.5);
                }
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };
    input.click();
}

// C√°c h√†m b·ªï tr·ª£ gi·ªØ nguy√™n
function sendCmd(p, v) {
    let status = (v == 1) ? "ON" : "OFF";
    let finalUrl = isLocal 
        ? `${basePrefix}/cmd?id=${idLookup[p]}&val=${status}`
        : `${basePrefix}?action=update&pin=${p}&value=${v}&device=${DEVICE_NAME}`;
    fetch(finalUrl, { mode: 'no-cors' });
    if ('speechSynthesis' in window) {
        window.speechSynthesis.speak(new SpeechSynthesisUtterance((v == 1 ? "B·∫≠t " : "T·∫Øt ") + (customNames[p] || p)));
    }
}

function updateStatusOnly() {
    let statusUrl = isLocal ? `${basePrefix}/get_status` : `${basePrefix}?action=get_all&device=${DEVICE_NAME}`;
    fetch(statusUrl).then(r => r.json()).then(data => {
        for (let p in data) {
            let onBtn = document.getElementById(`on-${p}`);
            let offBtn = document.getElementById(`off-${p}`);
            if(onBtn && offBtn) {
                if (data[p] == 1) {
                    onBtn.className = "btn btn-on active-on";
                    offBtn.className = "btn btn-off";
                } else {
                    onBtn.className = "btn btn-on";
                    offBtn.className = "btn btn-off active-off";
                }
            }
        }
    }).catch(e => {});
}

function addV2() {
    let t = document.getElementById('v2_t').value;
    let d = document.getElementById('v2_d').value;
    if(t && d) {
        if (listV2.length >= 6) return alert("T·ªëi ƒëa 6 l·∫ßn!");
        listV2.push({t, d}); renderUI(); 
    }
}

function saveV2(btn) {
    let full = [];
    for(let i=0; i<6; i++) {
        if(listV2[i]) {
            let p = listV2[i].t.split(':');
            full.push({id:i+1, h:parseInt(p[0]), m:parseInt(p[1]), d:parseInt(listV2[i].d), a:true});
        } else {
            full.push({id:i+1, h:0, m:0, d:0, a:false});
        }
    }
    localStorage.setItem('v2_list_cache', JSON.stringify(listV2));

    // S·ª¨A T·∫†I ƒê√ÇY: D√πng basePrefix ƒë·ªÉ g·ª≠i ƒë√∫ng ch·ªó
    let url = `${isLocal ? '' : 'http://' + IP_ESP32}/irrigation?d=` + encodeURIComponent(JSON.stringify(full));
    
    fetch(url).then(() => {
        btn.innerText = "‚úÖ ƒê√É L∆ØU!"; 
        btn.style.background = "#2ecc71";
        setTimeout(() => { btn.innerText = "G·ª¨I & L∆ØU L·ªäCH T∆Ø·ªöI"; btn.style.background = ""; }, 2000);
    }).catch(e => alert("Kh√¥ng g·ª≠i ƒë∆∞·ª£c l·ªãch, h√£y ki·ªÉm tra k·∫øt n·ªëi v·ªõi ESP32!"));
}

function addV10() {
    let id = document.getElementById('v10_id').value;
    let on = document.getElementById('v10_on').value;
    let off = document.getElementById('v10_off').value;
    if(on && off) {
        listV10 = listV10.filter(x => x.id !== id);
        listV10.push({id, on, off}); renderUI();
    }
}

async function saveV10(btn) {
    // 1. L∆∞u v√†o tr√¨nh duy·ªát tr∆∞·ªõc (Cache)
    localStorage.setItem('v10_list_cache', JSON.stringify(listV10));

    // 2. T·∫°o chu·ªói d·ªØ li·ªáu theo ƒë·ªãnh d·∫°ng ESP32 Gateway ƒëang d√πng: 
    // "id:1 08:00 true 22:00 false, id:2 07:00 true..."
    let dataStr = listV10.map(s => {
        return `id:${s.id} ${s.on} true ${s.off} false`;
    }).join(', ');

    if (!dataStr) {
        alert("Ch∆∞a c√≥ l·ªãch ƒë·ªÉ g·ª≠i!");
        return;
    }

    // 3. G·ª≠i qua Worker (Virtual Pin V10)
    // encodeURIComponent c·ª±c k·ª≥ quan tr·ªçng ƒë·ªÉ kh√¥ng l·ªói chu·ªói khi g·ª≠i qua Cloud
    const url = `${WORKER_URL}?action=update&pin=V10&value=${encodeURIComponent(dataStr)}&device=cay`;

    btn.innerText = "ƒêANG G·ª¨I...";
    
    try {
        const res = await fetch(url);
        if (res.ok) {
            btn.innerText = "‚úÖ ƒê√É ƒê·ªíNG B·ªò!";
            btn.style.background = "#2ecc71";
            setTimeout(() => { 
                btn.innerText = "G·ª¨I & L∆ØU L·ªäCH ƒê√àN"; 
                btn.style.background = ""; 
            }, 3000);
        } else {
            throw new Error("Worker tr·∫£ l·ªói");
        }
    } catch (err) {
        alert("L·ªói: Kh√¥ng th·ªÉ g·ª≠i l·ªãch qua Cloud. Ki·ªÉm tra Worker!");
        btn.innerText = "TH·ª¨ L·∫†I";
    }
}

function removeV2(i) {
    if(confirm("X√≥a l·ªãch?")) { listV2.splice(i, 1); renderUI(); saveV2({innerText:""}); }
}

function removeV10(i) {
    if(confirm("B·∫°n mu·ªën x√≥a l·ªãch ph√≤ng n√†y?")) {
        // L·∫•y ID c·ªßa ph√≤ng ƒëang ch·ªçn x√≥a
        let idToRemove = listV10[i].id; 
        
        // T·∫°o l·ªánh x√≥a theo ƒë·ªãnh d·∫°ng Slave hi·ªÉu: "DEL:id"
        // Ho·∫∑c g·ª≠i l·ªãch tr·ªëng: "id:1 00:00 true 00:00 false"
        let cmdDelete = `DEL:${idToRemove}`; 

        // G·ª≠i l·ªánh n√†y l√™n V10 qua Worker
        const url = `${WORKER_URL}?action=update&pin=V10&value=${encodeURIComponent(cmdDelete)}&device=cay`;
        
        fetch(url).then(res => {
            if(res.ok) {
                listV10.splice(i, 1); // X√≥a kh·ªèi giao di·ªán web
                renderUI();
                console.log("ƒê√£ g·ª≠i l·ªánh x√≥a ID:", idToRemove);
            }
        });
    }
}


async function deleteAllSchedules() {
    if (!confirm("‚ö†Ô∏è B·∫°n c√≥ mu·ªën X√ìA T·∫§T C·∫¢ l·ªãch ƒë√®n kh√¥ng?")) return;

    // G·ª≠i l·ªánh CLEAR_DEN l√™n V10 qua Worker
    const deleteUrl = `${WORKER_URL}?action=update&pin=V10&value=CLEAR_DEN&device=cay`;
    
    try {
        const res = await fetch(deleteUrl);
        if(res.ok) {
            alert("‚úÖ ƒê√£ g·ª≠i l·ªánh x√≥a l·ªãch ƒë√®n th√†nh c√¥ng!");
            // X√≥a s·∫°ch d·ªØ li·ªáu t·∫°m tr√™n tr√¨nh duy·ªát
            localStorage.removeItem('savedSchedules'); 
            location.reload(); 
        }
    } catch (err) {
        alert("L·ªói k·∫øt n·ªëi Worker!");
    }
}
function editName(p) {
    let oldName = (customNames[p] || p);
    let newName = prompt("T√™n m·ªõi:", oldName);
    if (newName && newName !== oldName) {
        fetch(`/set_name?pin=${p}&name=${encodeURIComponent(newName)}`).then(() => {
            customNames[p] = newName;
            localStorage.setItem('last_config', JSON.stringify(customNames));
            renderUI();
        });
    }
}

function phatWifiConfig() {
    let code = prompt("M√É X√ÅC TH·ª∞C:");
    if (!code) return;
    fetch('/phat_wifi_ap?auth_code=' + encodeURIComponent(code))
    .then(r => r.text()).then(txt => alert(txt)).catch(() => alert("ƒêang chuy·ªÉn ch·∫ø ƒë·ªô..."));
}
</script>

</body>
</html>
